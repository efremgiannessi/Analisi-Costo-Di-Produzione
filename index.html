<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Analisi Costo di Produzione ‚Äî V5.5 Ultimate</title>
  
  <!-- SheetJS -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- FontAwesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Google Fonts: Inter -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      /* Modern Palette */
      --bg-dark: #0f172a;
      --bg-gradient: radial-gradient(circle at top left, #1e293b, #0f172a);
      
      /* Glassmorphism Panels */
      --panel: rgba(30, 41, 59, 0.7); 
      --panel-border: rgba(255, 255, 255, 0.08);
      
      --muted: rgba(255,255,255,0.05); 
      --ink: #f8fafc; 
      --ink-2: #94a3b8; 
      
      /* Accents */
      --acc: #38bdf8;      /* Sky Blue */
      --acc-glow: rgba(56, 189, 248, 0.4);
      --ok: #4ade80;       /* Green */
      --warn: #fbbf24;     /* Amber */
      --err: #f87171;      /* Red */
      
      --grid: rgba(148, 163, 184, 0.1); 
      
      --shadow: 0 10px 40px -10px rgba(0,0,0,0.5);
      --radius: 16px;
      
      --z-modal: 2000; --z-toolbar: 100; --z-thead: 90;
    }

    * { box-sizing:border-box; }
    html,body { height:100%; margin:0; padding:0; }
    
    body {
      background: var(--bg-dark);
      background-image: var(--bg-gradient);
      background-attachment: fixed;
      color: var(--ink);
      font-family: 'Inter', sans-serif; /* Modern Font */
      font-size: 13px; /* Slightly smaller base for cleaner look */
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
    }

    .wrap { max-width:1440px; margin:0 auto; padding:24px; padding-bottom: 100px; }
    
    /* --- UTILITY & LAYOUT --- */
    .card { 
      background: var(--panel); 
      backdrop-filter: blur(16px); 
      -webkit-backdrop-filter: blur(16px);
      border: 1px solid var(--panel-border); 
      border-radius: var(--radius); 
      box-shadow: var(--shadow); 
      overflow:hidden; 
      margin-bottom:20px; 
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    
    .pad { padding:20px; }
    .h { display:flex; gap:12px; align-items:center; }
    .v { display:flex; flex-direction:column; gap:8px; }
    .row { display:grid; grid-template-columns:repeat(12,1fr); gap:16px; }
    .col { display:flex; flex-direction:column; gap:6px; }
    .hr { height:1px; background:linear-gradient(90deg,transparent,var(--grid),transparent); margin:20px 0; }
    .right { text-align:right; }
    .num { font-variant-numeric: tabular-nums; font-family: "Inter", sans-serif; font-weight: 500; letter-spacing: -0.2px; }
    .muted { color:var(--ink-2); }
    .small { font-size:12px; }
    .bold { font-weight:600; }
    .hidden { display:none !important; }

    /* --- TYPOGRAPHY & INPUTS --- */
    h1 { font-size:24px; margin:0; font-weight:700; color:var(--ink); letter-spacing: -0.5px; }
    h2 { font-size:14px; margin:0 0 16px; color:var(--acc); font-weight:600; text-transform:uppercase; letter-spacing:1px; opacity: 0.9; }
    
    input, select, textarea {
      width:100%; 
      background: rgba(0,0,0,0.2); 
      border: 1px solid var(--panel-border); 
      color: var(--ink);
      padding: 10px 12px; 
      border-radius: 8px; 
      outline: none; 
      font-family: inherit;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }
    input:focus, select:focus { 
      border-color: var(--acc); 
      background: rgba(0,0,0,0.4);
      box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.15); 
    }
    input::placeholder { color: rgba(255,255,255,0.2); }
    label { font-size:11px; color:var(--ink-2); font-weight:600; text-transform:uppercase; letter-spacing: 0.5px; }

    /* --- BUTTONS --- */
    button, .btn {
      background: rgba(255,255,255,0.05); 
      border: 1px solid rgba(255,255,255,0.1); 
      color: var(--ink);
      padding: 9px 16px; 
      border-radius: 8px; 
      cursor: pointer; 
      font-size: 13px; 
      font-weight: 500;
      transition: all 0.2s ease; 
      display: inline-flex; align-items: center; gap: 8px; justify-content: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    button:hover { 
      background: rgba(255,255,255,0.1); 
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    button:active { transform: translateY(0); }

    .btn-primary { 
      background: linear-gradient(135deg, var(--acc), #0ea5e9); 
      color: #000; 
      border: none; 
      font-weight: 600; 
      box-shadow: 0 4px 14px var(--acc-glow);
    }
    .btn-primary:hover { 
      background: linear-gradient(135deg, #7dd3fc, #38bdf8); 
      box-shadow: 0 6px 20px var(--acc-glow);
    }

    .btn-acc { background: rgba(56, 189, 248, 0.1); border-color: rgba(56, 189, 248, 0.3); color: var(--acc); }
    .btn-acc:hover { background: rgba(56, 189, 248, 0.2); border-color: var(--acc); }

    .btn-ok { background: rgba(74, 222, 128, 0.1); border-color: rgba(74, 222, 128, 0.3); color: var(--ok); }
    .btn-ok:hover { background: rgba(74, 222, 128, 0.2); border-color: var(--ok); }

    .btn-warn { background: rgba(251, 191, 36, 0.1); border-color: rgba(251, 191, 36, 0.3); color: var(--warn); }
    .btn-warn:hover { background: rgba(251, 191, 36, 0.2); border-color: var(--warn); }
    
    .btn-icon { padding: 9px; width: 38px; text-align: center; justify-content: center;}

    /* --- SPECIFIC LAYOUTS --- */
    .topbar {
      position: relative; 
      background: rgba(15, 23, 42, 0.6);
      backdrop-filter: blur(20px);
      border: 1px solid var(--panel-border); 
      border-radius: var(--radius); 
      box-shadow: var(--shadow);
      margin-bottom: 20px; padding: 16px 24px;
    }
    .projbar {
      display:grid; grid-template-columns:repeat(12,1fr); gap:16px;
      margin-top:16px; padding-top:16px; border-top:1px dashed var(--grid);
    }
    
    /* --- TABLE SCROLLABLE --- */
    .table-container { 
        position:relative; 
        overflow-y: auto; 
        overflow-x: auto; 
        max-height: 600px; 
        scroll-behavior: smooth; 
        border-bottom: 1px solid var(--grid);
        border-radius: 12px;
        background: rgba(0,0,0,0.1);
    }
    .table-container::-webkit-scrollbar { width: 8px; height: 8px; }
    .table-container::-webkit-scrollbar-track { background: transparent; }
    .table-container::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 4px; }
    .table-container::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.2); }

    .cost-head-sticky {
      position: sticky; top: 0; z-index: var(--z-toolbar);
      background: rgba(20, 30, 45, 0.95);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--grid);
      padding: 12px 20px; display: flex; justify-content: space-between; align-items: center;
      margin: 0 -16px; width: calc(100% + 32px); box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }

    table.grid { width:100%; border-collapse:separate; border-spacing:0; }
    .grid th, .grid td { border-bottom:1px solid var(--grid); padding:10px 12px; vertical-align:middle; transition: background 0.1s; }
    .grid th { text-align:left; font-weight:600; color:var(--ink-2); font-size:11px; text-transform:uppercase; letter-spacing: 0.5px; }
    .grid thead th {
      position: sticky; top: 56px; z-index: var(--z-thead);
      background: #1e293b; 
      border-bottom: 2px solid var(--grid);
      padding-top: 14px; padding-bottom: 14px;
    }
    .grid tbody tr:hover td { background:rgba(255,255,255,0.03); }
    .grid tbody tr.sel td { background:rgba(56, 189, 248, 0.15) !important; color: white; }
    
    [contenteditable] { cursor:text; border-radius:4px; padding:4px 6px; border: 1px solid transparent; transition: all 0.2s; }
    [contenteditable]:hover { background: rgba(255,255,255,0.05); }
    [contenteditable]:focus { background:rgba(0,0,0,0.3); border-color:var(--acc); color:var(--acc); box-shadow: 0 0 0 2px rgba(56, 189, 248, 0.1); }
    
    .grid tfoot th { text-align:right; color:var(--ink-2); padding-top:16px; border-bottom:none; }
    .grid tfoot td, .grid tfoot .num { font-size:15px; font-weight:700; color:var(--ink); border-bottom:none; padding-top:16px; }

    /* --- SUMMARY & STATS --- */
    .kv-grid { display:grid; grid-template-columns: 1fr 120px; gap:8px 16px; align-items:center; }
    .kv-grid label { font-size:12px; color:var(--ink-2); font-weight:500; text-transform:none; }
    .kv-grid .val { text-align:right; font-family:"Inter", monospace; font-size:13px; color: white; font-weight: 500; }

    .stat-card {
      background: linear-gradient(145deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01)); 
      border: 1px solid var(--panel-border);
      border-radius: 12px; padding: 16px; display:flex; flex-direction:column; gap:6px;
      transition: transform 0.2s;
    }
    .stat-card:hover { transform: translateY(-2px); border-color: rgba(255,255,255,0.2); }
    .stat-val { font-size:22px; font-weight:700; color:#fff; letter-spacing: -0.5px; }
    .stat-lbl { font-size:11px; color:var(--acc); text-transform:uppercase; letter-spacing:1px; font-weight: 600; opacity: 0.8; }

    /* --- TABS SYSTEM --- */
    .nav-tabs { 
      display:flex; gap:6px; 
      border-bottom:1px solid var(--panel-border); 
      background: rgba(0,0,0,0.2); 
      padding:6px; margin-bottom:20px; border-radius:12px; 
    }
    .nav-tab {
      padding:10px 24px; cursor:pointer; 
      border-radius: 8px; border-bottom: none;
      color:var(--ink-2); font-weight:500; font-size:13px; 
      transition:all 0.2s;
    }
    .nav-tab:hover { color:var(--ink); background:rgba(255,255,255,0.05); }
    .nav-tab.active { 
      color: #fff; 
      background: var(--acc); 
      box-shadow: 0 4px 12px var(--acc-glow);
      font-weight: 600;
    }
    .tab-content { display:none; animation: fadeScale 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
    .tab-content.active { display:block; }
    @keyframes fadeScale { 
      from { opacity:0; transform:scale(0.98); } 
      to { opacity:1; transform:scale(1); } 
    }

    /* --- DB & MODAL --- */
    .db-row { display:grid; grid-template-columns: 1fr 2fr 80px 80px 100px 40px; gap:8px; align-items:center; padding:12px 0; border-bottom:1px solid var(--grid); }
    .modal-overlay { 
      position:fixed; top:0; left:0; width:100%; height:100%; 
      background:rgba(0,0,0,0.6); backdrop-filter:blur(8px);
      z-index: var(--z-modal); display:flex; align-items:center; justify-content:center;
      opacity:0; pointer-events:none; transition:opacity 0.2s ease-out;
    }
    .modal-overlay.active { opacity:1; pointer-events:all; }
    .modal { 
      background:#1e293b; border:1px solid var(--panel-border); 
      padding:32px; border-radius:24px; max-width:480px; width:90%; 
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); 
      transform:translateY(20px) scale(0.95); transition:all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      display:flex; flex-direction:column; gap:16px;
    }
    .modal-overlay.active .modal { transform:translateY(0) scale(1); }
    .catalog-list { max-height:300px; overflow-y:auto; border:1px solid var(--grid); border-radius:12px; margin-top:8px; background: rgba(0,0,0,0.2); }
    .catalog-item { padding:12px 16px; border-bottom:1px solid var(--grid); cursor:pointer; display:flex; justify-content:space-between; transition: background 0.1s; }
    .catalog-item:hover { background: rgba(56, 189, 248, 0.1); }

    /* --- ABACHI --- */
    #abachi-tabs { display:flex; gap:8px; overflow-x:auto; padding-bottom:8px; border-bottom:1px solid var(--grid); margin-bottom:12px; }
    #abachi-tabs button { white-space:nowrap; }
    #abachi-tabs button.active { background:var(--acc); color:#000; border-color:var(--acc); }
    #abachi-host .sheet { display:none; max-height:500px; overflow:auto; background:#fff; color:#000; padding:16px; border-radius:8px; }
    #abachi-host .sheet.active { display:block; }
    #abachi-host table { border-collapse:collapse; width:100%; font-size:12px; }
    #abachi-host td, #abachi-host th { border:1px solid #ccc; padding:4px; }

    /* --- FLOAT BTN --- */
    #btn-calc-fixed {
      position:fixed; bottom:32px; right:32px; z-index:999;
      background:var(--acc); color:#0f172a; 
      width:64px; height:64px; border-radius:50%;
      display:flex; align-items:center; justify-content:center;
      font-size:24px; box-shadow:0 10px 30px var(--acc-glow);
      border:none; cursor:pointer; transition:transform 0.2s, box-shadow 0.2s;
    }
    #btn-calc-fixed:hover { transform:scale(1.1) rotate(90deg); box-shadow:0 15px 40px var(--acc-glow); }

    /* --- PRINT --- */
    @media print {
      body { background: #fff !important; color: #000 !important; font-family: "Times New Roman", serif; font-size: 11pt; }
      .wrap { max-width: 100% !important; margin: 0; padding: 0; }
      .card { border: none !important; box-shadow: none !important; border-radius: 0 !important; background: none !important; margin-bottom: 20px !important; backdrop-filter: none !important; }
      .topbar button, .cost-head-sticky, #btn-calc-fixed, .modal-overlay, #abachi-card, #scenarios-card, .stat-card, canvas, #btn-save-as, .nav-tabs { display: none !important; }
      .topbar { border:none; box-shadow:none; background:none; padding:0; margin-bottom:10px; }
      .projbar { border-top: 1px solid #000; padding-top: 10px; margin-top: 10px; }
      input, select, textarea { border: none !important; background: none !important; color: #000 !important; padding: 0 !important; font-weight: bold; width: auto !important; -webkit-appearance: none; }
      table.grid { width: 100%; border-collapse: collapse; border: 1px solid #000; }
      .grid th, .grid td { border: 1px solid #ccc !important; padding: 4px; color: #000 !important; }
      .grid thead th { background: #eee !important; color: #000 !important; position: static !important; }
      .tab-content { display:block !important; }
      #tab-bi, #tab-db, #tab-info { display:none !important; }
      .footer-print { display: block !important; text-align: center; margin-top: 30px; border-top: 1px solid #000; padding-top: 10px; }
    }
    .footer-print { display: none; }
  </style>
</head>
<body>

<!-- Floating Calc Button -->
<button id="btn-calc-fixed" title="Calcola">üßÆ</button>

<!-- CUSTOM MODAL -->
<div id="custom-modal" class="modal-overlay">
  <div class="modal">
    <h3 id="modal-title">Titolo</h3>
    <div id="modal-content"><p id="modal-msg">Messaggio...</p></div>
    <div class="modal-actions">
      <button id="modal-cancel" class="btn">Chiudi</button>
      <button id="modal-confirm" class="btn-primary" style="display:none">Conferma</button>
    </div>
  </div>
</div>

<!-- CATALOG MODAL (REINSTATED) -->
<div id="cat-modal" class="modal-overlay">
  <div class="modal" style="max-height:80vh">
    <div class="h" style="justify-content:space-between">
       <h3>Catalogo Voci</h3>
       <button onclick="document.getElementById('cat-modal').style.display='none'" class="btn">Chiudi</button>
    </div>
    <input placeholder="Cerca nel catalogo..." id="cat-search" style="margin-bottom:8px">
    <div id="modal-db-list" class="catalog-list"></div>
  </div>
</div>

<div class="wrap">

  <!-- HEADER -->
  <div class="card" style="padding:20px 24px; background: linear-gradient(90deg, #0f172a, #334155); margin-bottom:24px;">
    <div class="h" style="justify-content:space-between">
      <div class="h">
        <div style="background:var(--acc); color:#0f172a; font-weight:800; padding:4px 12px; border-radius:20px; font-size:11px; box-shadow: 0 0 10px var(--acc-glow);">V5.5 ULTIMATE</div>
        <div>
          <h1 style="font-size:24px; margin:0;">Analisi Costo & Controllo</h1>
          <div class="small muted">Piattaforma Gestionale Completa</div>
        </div>
      </div>
      <div class="h">
        <button onclick="applySummary()" class="btn-primary"><i class="fa-solid fa-calculator"></i> Ricalcola</button>
      </div>
    </div>
  </div>

  <!-- NAVIGATION TABS -->
  <div class="nav-tabs">
    <div class="nav-tab active" onclick="switchTab('costi')"><i class="fa-solid fa-list-check"></i> Analisi Costi</div>
    <div class="nav-tab" onclick="switchTab('bi')"><i class="fa-solid fa-chart-line"></i> Business Intelligence</div>
    <div class="nav-tab" onclick="switchTab('db')"><i class="fa-solid fa-database"></i> Database Listini</div>
    <div class="nav-tab" onclick="switchTab('info')"><i class="fa-solid fa-circle-info"></i> Info & Checklist</div>
  </div>

  <!-- TAB 1: ANALISI COSTI -->
  <div id="tab-costi" class="tab-content active">
      
      <!-- TOPBAR -->
      <div class="topbar">
        <div class="h" style="justify-content:space-between">
           <div class="h">
             <h1>Dati di Progetto</h1>
           </div>
           <div class="h">
             <button id="btn-calc" class="btn-acc">Calcola</button>
             <button id="btn-print" class="btn">üñ®Ô∏è Stampa</button>
             <button id="btn-save" class="btn-primary">Salva</button>
           </div>
        </div>
        
        <div class="projbar">
           <div class="col" style="grid-column: span 4">
              <label>Nome Commessa</label>
              <input id="job-name" type="text" placeholder="Es. Capannone Logistica MI" />
           </div>
           <div class="col" style="grid-column: span 2">
              <label>Data</label>
              <input id="job-date" type="date" />
           </div>
           <div class="col" style="grid-column: span 2">
              <label>Sup. Montaggio (m¬≤)</label>
              <input id="sup-mont" type="text" class="num right" placeholder="0,00" />
           </div>
           <div class="col" style="grid-column: span 2">
              <label>Sup. Pannelli (m¬≤)</label>
              <input id="sup-pan" type="text" class="num right" placeholder="0,00" />
           </div>
        </div>
      </div>

      <!-- GEOMETRIA ELEMENTO -->
      <div class="card pad" style="margin-bottom:20px;">
        <div class="h" style="justify-content:space-between">
           <h2>Dati Elemento</h2>
           <button id="btn-geom-calc" class="btn small btn-icon" title="Calcolatrice Geometrica Avanzata">üìê</button>
        </div>
        <div class="row">
           <div class="col" style="grid-column: span 3">
              <label>Tipologia</label>
              <select id="el-type">
                 <option value="Elemento precompresso">Struttura / Trave</option>
                 <option value="Pannello precompresso">Pannello / Tamponamento</option>
                 <option value="Altra tipologia">Generico</option>
              </select>
           </div>
           <div class="col" style="grid-column: span 4">
              <label>Descrizione Elemento</label>
              <input id="el-desc" placeholder="es. Trave I 80x120 L=20m" />
           </div>
           <div class="col" style="grid-column: span 1">
              <label>L (m)</label>
              <input id="len" type="number" step="0.01" class="right" />
           </div>
           <div class="col" style="grid-column: span 1">
              <label>B (m)</label>
              <input id="wid" type="number" step="0.01" class="right" />
           </div>
           <div class="col" style="grid-column: span 1">
              <label>H (m)</label>
              <input id="hei" type="number" step="0.01" class="right" />
           </div>
           <div class="col" style="grid-column: span 1">
              <label>Vol (m¬≥)</label>
              <input id="vol" type="number" step="0.001" class="right" style="border-color:var(--acc)" />
           </div>
           <div class="col" style="grid-column: span 1">
              <label>Peso (t)</label>
              <input id="peso" type="text" readonly class="muted right" tabindex="-1" />
           </div>
        </div>
      </div>

      <!-- TABELLA COSTI SCORREVOLE -->
      <div class="card pad table-container" style="margin-bottom:20px;">
        <div class="cost-head-sticky">
           <div class="h">
             <h2>Voci di Costo</h2>
             <select id="filter-cat" style="width:180px; height:36px; padding:0 12px;">
                <option value="">Tutte le categorie</option>
                <option>Materiali</option>
                <option>Manodopera</option>
                <option>Trasporti</option>
                <option>Montaggio</option>
                <option>Esterni</option>
             </select>
           </div>
           <div class="h">
             <button id="btn-catalog" class="btn-acc">üìö Catalogo</button>
             <div style="width:1px;height:24px;background:var(--grid)"></div>
             <button id="add-row" class="btn">Aggiungi</button>
             <button id="dup-row" class="btn">Duplica</button>
             <button id="del-row" class="btn-warn">Elimina</button>
           </div>
        </div>

        <table class="grid" id="cost-grid">
           <thead>
             <tr>
                 <th style="width:40px; text-align:center">#</th>
                 <th style="width:140px">Categoria</th>
                 <th>Descrizione Voce</th>
                 <th class="right" style="width:80px">Q.t√†</th>
                 <th style="width:60px">UM</th>
                 <th class="right" style="width:100px">Costo Unit.</th>
                 <th class="right" style="width:80px">K o.c. %</th>
                 <th class="right" style="width:110px">Totale</th>
                 <th style="width:150px">Note</th>
             </tr>
           </thead>
           <tbody id="tbody">
             <!-- Righe generate via JS -->
           </tbody>
           <tfoot>
             <tr>
                 <td colspan="7" class="right muted">Totale Materiali</td>
                 <td class="right num" id="tot-mat">0,00 ‚Ç¨</td>
                 <td></td>
             </tr>
             <tr>
                 <td colspan="7" class="right muted">Totale Manodopera</td>
                 <td class="right num" id="tot-man">0,00 ‚Ç¨</td>
                 <td></td>
             </tr>
             <tr>
                 <td colspan="7" class="right muted">Totale Altri (Noli, Trasporti, Montaggio...)</td>
                 <td class="right num" id="tot-alt">0,00 ‚Ç¨</td>
                 <td></td>
             </tr>
             <tr>
                 <td colspan="7" class="right" style="font-size:16px; color:var(--acc); font-weight:600">COSTO DIRETTO DI PRODUZIONE</td>
                 <td class="right num" id="tot-diretto" style="font-size:18px; color:var(--acc); border-top:1px solid var(--grid); font-weight:700">0,00 ‚Ç¨</td>
                 <td></td>
             </tr>
           </tfoot>
        </table>
        <div class="small muted" style="margin-top:12px; font-style: italic;">
           Doppio click sulle celle per modificare. "K o.c." √® il coefficiente opere complementari.
        </div>
      </div>

      <!-- RIEPILOGO E PARAMETRI -->
      <div class="card pad">
         <div class="row" style="grid-template-columns: 1fr 1fr; gap:40px;">
            <div class="col">
               <h2>Parametri economici</h2>
               <div class="kv-grid">
                  <label>Spese generali (%)</label><input id="pct-gg" class="right" value="8" />
                  <label>Imprevisti (%)</label><input id="pct-imp" class="right" value="2" />
                  <label>Provvigione (%) <span class="muted small">(ricarico inverso)</span></label><input id="pct-provv" class="right" value="0" />
                  <label>Utile (%)</label><input id="pct-ut" class="right" value="10" />
                  <label>Margine di profitto (%)</label><input id="pct-margine" class="right" value="30" />
                  <label>IVA (%)</label><input id="pct-iva" class="right" value="22" />
                  <label>Sconto (%)</label><input id="pct-sconto" class="right" value="0" />
                  <div class="hr" style="grid-column:span 2; margin:12px 0;"></div>
                  <label>Produzione/lotto (pezzi)</label><input id="pezzi" class="right" value="1" />
                  <label>Metri lineari per pezzo (m)</label><input id="ml-per-pezzo" class="right" value="0" />
                  <label>Metri quadrati per pezzo (m¬≤)</label><input id="mq-per-pezzo" class="right" value="0" />
               </div>
            </div>

            <div class="col" style="border-left:1px solid var(--grid); padding-left:40px;">
               <h2>Riepilogo</h2>
               <div class="kv-grid">
                  <label>Costo diretto</label><div class="val" id="r-dir">0,00 ‚Ç¨</div>
                  <label class="muted small">+ Spese generali</label><div class="val" id="r-gg">0,00 ‚Ç¨</div>
                  <label class="muted small">+ Imprevisti</label><div class="val" id="r-imp">0,00 ‚Ç¨</div>
                  <label style="color:var(--ink); font-weight:bold">Subtotale industriale</label><div class="val" id="r-sub" style="font-weight:bold; border-top:1px solid var(--grid); color: var(--acc)">0,00 ‚Ç¨</div>
                  <label class="muted small">+ Provvigione (ricarico)</label><div class="val" id="r-provv">0,00 ‚Ç¨</div>
                  <label class="muted small">+ Utile</label><div class="val" id="r-ut">0,00 ‚Ç¨</div>
                  <label class="muted small">+ Margine di profitto (ricarico)</label><div class="val" id="r-margine">0,00 ‚Ç¨</div>
                  <label style="color:var(--ink)">Prezzo netto</label><div class="val" id="r-netto">0,00 ‚Ç¨</div>
                  <label class="muted small">+ IVA</label><div class="val" id="r-iva">0,00 ‚Ç¨</div>
                  <label style="font-size:18px; font-weight:bold; color:var(--ink)">Prezzo totale</label><div class="val" id="r-totale" style="font-size:18px; font-weight:bold; color:var(--ok)">0,00 ‚Ç¨</div>
                  <label class="muted small">‚Äì Sconto</label><div class="val" id="r-sconto">0,00 ‚Ç¨</div>
                  <label style="font-size:18px; font-weight:bold; color:var(--ink)">Totale scontato</label><div class="val" id="r-totale-sconto" style="font-size:18px; font-weight:bold; color:var(--ok)">0,00 ‚Ç¨</div>
                  <label class="muted small">Margine commessa (%)</label><div class="val" id="r-margine-commessa">0,00 %</div>
               </div>
               <div class="hr"></div>
               <div class="kv-grid">
                  <label>Prezzo / pezzo</label><div class="val" id="r-per-pezzo">0,00 ‚Ç¨</div>
                  <label>Prezzo / m lineare</label><div class="val" id="r-per-ml">0,00 ‚Ç¨</div>
                  <label>Prezzo / m¬≤</label><div class="val" id="r-per-mq">0,00 ‚Ç¨</div>
                  <label>Prezzo / m¬≥</label><div class="val" id="r-per-mc">0,00 ‚Ç¨</div>
                  <label>Prezzo Struttura / m¬≥</label><div class="val" id="r-per-mc-struttura">0,00 ‚Ç¨</div>
               </div>
            </div>
         </div>
      </div>

      <!-- STATISTICHE E GRAFICI (Con Simulatore "What-If" POTENZIATO) -->
      <div class="card pad" style="margin-top:20px;">
         <div class="h" style="justify-content:space-between">
            <h2>Statistiche & Simulazione</h2>
            <div class="pill small muted" style="border:1px solid var(--warn); padding:4px 12px; border-radius:20px; color:var(--warn); background: rgba(251, 191, 36, 0.1);">
               Simulazione attiva: Costi materiali <span id="sim-display" style="font-weight:bold">+0%</span>
            </div>
         </div>
         <div class="row">
            <div class="col" style="grid-column: span 4; align-items:center;">
               <div style="height:250px; width:100%; position:relative;">
                  <canvas id="costPieChart"></canvas>
               </div>
            </div>
            <div class="col" style="grid-column: span 8;">
               <!-- Slider What-If Potenziato con Elenco Voci Specifiche -->
               <div style="background:rgba(0,0,0,0.2); padding:16px; border-radius:12px; margin-bottom:16px; border:1px solid var(--panel-border)">
                  <div class="h" style="justify-content:space-between; margin-bottom:8px">
                     <label style="color:var(--warn)">Target Simulazione</label>
                     <select id="sim-target" onchange="applySummary()" style="background:rgba(0,0,0,0.4); color:#fff; border:1px solid var(--grid); padding:6px; border-radius:6px; font-size:12px;">
                        <option value="all">Tutto (Globale)</option>
                        <option value="mat">Categoria: Materiali</option>
                        <option value="man">Categoria: Manodopera</option>
                        <option value="tras">Categoria: Trasporti</option>
                        <option disabled>--- Voci Specifiche ---</option>
                        <option value="calcestruzzo">Solo Calcestruzzo</option>
                        <option value="acciaio">Solo Acciaio</option>
                        <option value="trefolo">Solo Trefolo</option>
                        <option value="trasporti_voce">Solo Trasporti (Voce)</option>
                     </select>
                     <span id="sim-val" style="font-weight:bold; color:var(--warn); font-size: 14px;">0%</span>
                  </div>
                  <input type="range" id="sim-slider" min="-20" max="50" value="0" style="width:100%; accent-color:var(--warn); height: 4px;">
                  <div class="small muted" style="margin-top:4px">Sposta per vedere come cambia il margine variando solo la voce selezionata.</div>
               </div>
               <div class="row" style="margin-bottom:16px;">
                  <div class="col" style="grid-column: span 4">
                     <div class="stat-card">
                        <span class="stat-lbl">Incidenza Manodopera</span><span class="stat-val" id="stat-inc-man">0%</span>
                     </div>
                  </div>
                  <div class="col" style="grid-column: span 4">
                     <div class="stat-card">
                        <span class="stat-lbl">Costo al kg (Finito)</span><span class="stat-val" id="stat-eur-kg">0,00 ‚Ç¨</span>
                     </div>
                  </div>
                  <div class="col" style="grid-column: span 4">
                     <div class="stat-card">
                        <span class="stat-lbl">Moltiplicatore</span><span class="stat-val" id="stat-mult">1.0x</span>
                     </div>
                  </div>
               </div>
               <div style="height:150px; width:100%;">
                  <canvas id="categoryBarChart"></canvas>
               </div>
            </div>
         </div>
      </div>

      <!-- TOOLBAR AZIONI -->
      <div class="card pad h" style="margin-top:20px; justify-content:space-between; flex-wrap:wrap">
         <div class="h">
           <button id="btn-reset" class="btn">Nuovo / Pulisci</button>
           <button id="btn-seed" class="btn">Ricarica Default</button>
           <button id="btn-save-as" class="btn">Salva HTML</button>
           <div style="width:1px; height:24px; background:var(--grid)"></div>
           <div class="pill h" style="background:rgba(0,0,0,0.2); padding:6px 12px; border-radius:20px; border:1px solid var(--panel-border)">
              <span class="small muted">Scenari:</span>
              <button onclick="saveScenario('A')" class="btn small" style="padding:4px 10px">üíæ A</button>
              <button onclick="loadScenario('A')" class="btn small" style="padding:4px 10px">üìÇ A</button>
              <div style="width:1px; height:16px; background:var(--grid)"></div>
              <button onclick="saveScenario('B')" class="btn small" style="padding:4px 10px">üíæ B</button>
              <button onclick="loadScenario('B')" class="btn small" style="padding:4px 10px">üìÇ B</button>
           </div>
         </div>
         <div class="h">
           <button id="btn-abachi" class="btn-acc">Importa Abachi Revit</button>
           <div style="width:1px; height:24px; background:var(--grid)"></div>
           <button id="btn-export-xlsx" class="btn-ok">Esporta Excel</button>
           <button id="btn-import-xlsx" class="btn">Importa Excel</button>
         </div>
      </div>

      <!-- ABACHI HIDDEN -->
      <div class="card pad" id="abachi-card" style="margin-top:20px; display:none">
         <div class="h" style="justify-content:space-between">
            <h2>Abachi Revit Importati</h2>
            <button onclick="document.getElementById('abachi-card').style.display='none'" class="btn small">Chiudi</button>
         </div>
         <div id="abachi-tabs"></div>
         <div id="abachi-host"></div>
      </div>
      <div class="muted small right" style="margin-top:20px; opacity: 0.5;">V 5.5 Ultimate - Full DB</div>
      <div class="footer-print">Documento generato automaticamente - Analisi Costi V5.5</div>
  </div>

  <!-- TAB 2: BUSINESS INTELLIGENCE (ENHANCED) -->
  <div id="tab-bi" class="tab-content">
     <div class="row">
        <!-- KPIs ROW 1 -->
        <div class="col" style="grid-column: span 12">
           <div class="row" style="margin-bottom:10px;">
              <div class="col" style="grid-column: span 2"><div class="stat-card"><span class="stat-lbl" style="color:var(--ok)">Margine Contribuzione</span><span class="stat-val text-ok" id="bi-mc" style="color:var(--ok); font-size:18px">0.00 ‚Ç¨</span></div></div>
              <div class="col" style="grid-column: span 2"><div class="stat-card"><span class="stat-lbl" style="color:var(--warn)">Break-even (Pezzi)</span><span class="stat-val text-warn" id="bi-bep" style="color:var(--warn); font-size:18px">0</span></div></div>
              <div class="col" style="grid-column: span 2"><div class="stat-card"><span class="stat-lbl" style="color:var(--acc)">ROI Stimato</span><span class="stat-val text-acc" id="bi-roi" style="color:var(--acc); font-size:18px">0%</span></div></div>
              <div class="col" style="grid-column: span 2"><div class="stat-card"><span class="stat-lbl">Costi Fissi (Est.)</span><span class="stat-val" id="bi-fixed" style="font-size:18px">0.00 ‚Ç¨</span></div></div>
              <div class="col" style="grid-column: span 2"><div class="stat-card"><span class="stat-lbl" style="color:#a855f7">Margine Sicurezza</span><span class="stat-val" id="bi-safe" style="color:#a855f7; font-size:18px">0%</span></div></div>
              <div class="col" style="grid-column: span 2"><div class="stat-card"><span class="stat-lbl">Markup Reale</span><span class="stat-val" id="bi-markup" style="font-size:18px">0%</span></div></div>
           </div>
        </div>
        
        <!-- CHART ROW 1 -->
        <div class="col" style="grid-column: span 6">
           <div class="card pad">
              <h3>Equilibrio Costi (Radar)</h3>
              <div style="height:280px; position:relative;"><canvas id="radarChart"></canvas></div>
           </div>
        </div>
        <div class="col" style="grid-column: span 6">
           <div class="card pad">
              <h3>Analisi Break-even Point</h3>
              <div style="height:280px; position:relative;"><canvas id="beChart"></canvas></div>
           </div>
        </div>

        <!-- CHART ROW 2 (NEW) -->
        <div class="col" style="grid-column: span 7">
           <div class="card pad">
              <h3>Composizione del Prezzo (Waterfall)</h3>
              <div style="height:280px; position:relative;"><canvas id="waterfallChart"></canvas></div>
           </div>
        </div>
        <div class="col" style="grid-column: span 5">
           <div class="card pad">
              <h3>Marginalit√† Operativa</h3>
              <div style="height:280px; position:relative;"><canvas id="profitabilityChart"></canvas></div>
           </div>
        </div>
     </div>
  </div>

  <!-- TAB 3: DATABASE MANAGER -->
  <div id="tab-db" class="tab-content">
     <div class="row">
        <div class="col" style="grid-column: span 8">
           <div class="card pad">
              <div class="h" style="justify-content:space-between; margin-bottom:16px;">
                 <h2>Database Listini</h2>
                 <button class="btn-primary" onclick="addDbItem()">+ Aggiungi Voce</button>
              </div>
              <div class="db-row" style="font-weight:bold; color:var(--acc); border-bottom: 2px solid var(--grid);"><div>Categoria</div><div>Descrizione</div><div class="right">UM</div><div class="right">Prezzo</div><div class="right">K %</div><div></div></div>
              <div id="db-list" style="max-height:500px; overflow-y:auto; padding-right: 8px;"></div>
           </div>
        </div>
        <div class="col" style="grid-column: span 4">
           <div class="card pad">
              <h3>Composizione DB</h3>
              <div style="height:250px;"><canvas id="dbPieChart"></canvas></div>
           </div>
        </div>
     </div>
  </div>

  <!-- TAB 4: INFO & CHECKLIST -->
  <div id="tab-info" class="tab-content">
     <div class="row">
        <div class="col" style="grid-column: span 6">
           <div class="card pad">
              <h3>Checklist Controllo</h3>
              <div id="checklist-container">
                 <label style="display:block; margin:12px 0; font-size:13px; display:flex; align-items:center; gap:8px;"><input type="checkbox" onchange="updateChecklist()" style="width:20px; height:20px;"> Verifica quote geometriche</label>
                 <label style="display:block; margin:12px 0; font-size:13px; display:flex; align-items:center; gap:8px;"><input type="checkbox" onchange="updateChecklist()" style="width:20px; height:20px;"> Aggiornamento prezzi acciaio</label>
                 <label style="display:block; margin:12px 0; font-size:13px; display:flex; align-items:center; gap:8px;"><input type="checkbox" onchange="updateChecklist()" style="width:20px; height:20px;"> Inclusione sfridi (3-5%)</label>
                 <label style="display:block; margin:12px 0; font-size:13px; display:flex; align-items:center; gap:8px;"><input type="checkbox" onchange="updateChecklist()" style="width:20px; height:20px;"> Verifica trasporti eccezionali</label>
                 <label style="display:block; margin:12px 0; font-size:13px; display:flex; align-items:center; gap:8px;"><input type="checkbox" onchange="updateChecklist()" style="width:20px; height:20px;"> Approvazione Responsabile</label>
              </div>
           </div>
        </div>
        <div class="col" style="grid-column: span 6">
           <div class="card pad" style="align-items:center; justify-content:center;">
              <h3>Stato Completamento</h3>
              <div style="height:200px; width:200px;"><canvas id="checklistChart"></canvas></div>
              <div id="checklist-text" style="font-size:32px; font-weight:bold; margin-top:16px; color: var(--acc);">0%</div>
           </div>
        </div>
     </div>
  </div>

</div>

<!-- TEMPLATE RIGA -->
<template id="row-template">
  <tr>
    <td class="muted right num row-idx" style="font-size:11px"></td>
    <td contenteditable data-key="categoria" spellcheck="false"></td>
    <td contenteditable data-key="voce" spellcheck="false"></td>
    <td class="right num" contenteditable data-key="qty"></td>
    <td contenteditable data-key="um" class="muted" style="text-align:center"></td>
    <td class="right num" contenteditable data-key="costo"></td>
    <td class="right num" contenteditable data-key="koc"></td>
    <td class="right num" data-key="tot" style="font-weight:bold; color:var(--ink)"></td>
    <td contenteditable data-key="note" class="muted small"></td>
  </tr>
</template>

<input type="file" id="file-import-xlsx" accept=".xlsx" style="display:none" />
<input type="file" id="file-abachi" accept=".xlsx" style="display:none" />

<script>
// --- UTILS ---
const fmt = new Intl.NumberFormat('it-IT', {minimumFractionDigits:2, maximumFractionDigits:2});
const safe = v => Number.isFinite(v) ? v : 0; // New Safe Number helper
const money = v => `${fmt.format(safe(v))} ‚Ç¨`; // Safe Money formatter

function parseSmart(val){ 
  if(typeof val==='number') return safe(val); 
  if(!val) return 0; 
  let s=String(val).replace(/‚Ç¨/g,'').replace(/\s/g,''); 
  if(s.includes(',')&&s.indexOf('.')<s.indexOf(',')) s=s.replace(/\./g,'').replace(',','.'); 
  else if(s.includes(',')) s=s.replace(',','.'); 
  const v=parseFloat(s); 
  return safe(v); 
}

function setNum(el, v, isMoney=false) { 
  if(el) el.textContent=isMoney?money(v):fmt.format(safe(v)); 
}

// --- STATE & VARS ---
let sensitivityFactor = 0;
// FULL DATABASE POPULATION WITH MARKET AVERAGES
const STANDARD_ITEMS = [
  {c:'Materiali', d:'Calcestruzzo C45/55', u:'m¬≥', p:115.00, k:0},
  {c:'Materiali', d:'Additivo fluidificante', u:'kg', p:1.20, k:0},
  {c:'Materiali', d:'Disarmante casseri', u:'kg', p:2.50, k:0},
  {c:'Materiali', d:'Coibente / Isolante', u:'m¬≥', p:75.00, k:0},
  {c:'Materiali', d:'Alleggerimento (es. EPS)', u:'m¬≥', p:45.00, k:0},
  {c:'Materiali', d:'Trefolo precompresso 0,6" (√ò 15,7)', u:'kg', p:1.10, k:0},
  {c:'Materiali', d:'Tralicci', u:'kg', p:1.45, k:0},
  {c:'Materiali', d:'Acciaio diritto passivo ‚Äì barre/staffe B450C', u:'kg', p:0.80, k:0},
  {c:'Materiali', d:'Acciaio lavorato passivo ‚Äì barre/staffe B450C', u:'kg', p:1.25, k:0},
  {c:'Materiali', d:'Rete elettrosaldata dritta', u:'kg', p:0.90, k:0},
  {c:'Materiali', d:'Rete elettrosaldata lavorata', u:'kg', p:1.35, k:0},
  {c:'Materiali', d:'Guaina / distanziatori trefoli', u:'m', p:0.50, k:0},
  {c:'Materiali', d:'Inserti (bussole, golfari, piastre)', u:'pz', p:12.00, k:0},
  {c:'Materiali', d:'Sigillanti / resine / ancoranti chimici', u:'kg', p:18.00, k:0},
  {c:'Materiali', d:'Casseri ausiliari / sponde', u:'lotto', p:250.00, k:0},
  {c:'Manodopera', d:'Tracciatura / preparazione cassero', u:'h', p:28.00, k:0},
  {c:'Manodopera', d:'Posa armature passive', u:'h', p:28.00, k:0},
  {c:'Manodopera', d:'Posa trefoli e tensionamento', u:'h', p:30.00, k:0},
  {c:'Manodopera', d:'Getto calcestruzzo', u:'h', p:28.00, k:0},
  {c:'Manodopera', d:'Cura/gestione ciclo (maturazione)', u:'h', p:26.00, k:0},
  {c:'Manodopera', d:'Taglio/ritensionamento trefoli', u:'h', p:30.00, k:0},
  {c:'Manodopera', d:'Disarmo e finitura', u:'h', p:28.00, k:0},
  {c:'Manodopera', d:'Controlli qualit√† / dimensione', u:'h', p:32.00, k:0},
  {c:'Manodopera', d:'Movimentazioni interne / carico', u:'h', p:28.00, k:0},
  {c:'Energia/Cura', d:'Energia elettrica / vapore ciclo', u:'kWh', p:0.25, k:0},
  {c:'Impianti/Noli', d:'Uso impianti / linee / piste', u:'h', p:45.00, k:0},
  {c:'Impianti/Noli', d:'Nolo betonpompa / attrezzature getto', u:'h', p:85.00, k:0},
  {c:'Impianti/Noli', d:'Nolo gru interna / carroponti', u:'h', p:65.00, k:0},
  {c:'Impianti/Noli', d:'Vibratori / attrezzature finitura', u:'h', p:15.00, k:0},
  {c:'Attrezzature/Stampi', d:'Ammortamento stampi specifici', u:'pz', p:50.00, k:0},
  {c:'Attrezzature/Stampi', d:'Manutenzione stampi / attrezzature', u:'pz', p:20.00, k:0},
  {c:'Qualit√†/Collaudi', d:'Prove cubetti / certificazioni cls', u:'lotto', p:150.00, k:0},
  {c:'Qualit√†/Collaudi', d:'Controlli dimensionali e visivi', u:'lotto', p:80.00, k:0},
  {c:'Sicurezza/Ambiente', d:'DPI / sicurezza ciclo produttivo', u:'pz', p:10.00, k:0},
  {c:'Sicurezza/Ambiente', d:'Smaltimenti / fanghi / rifiuti', u:'lotto', p:120.00, k:0},
  {c:'Logistica interna', d:'Movimentazioni interne aggiuntive', u:'h', p:45.00, k:0},
  {c:'Imballo/Stoccaggio', d:'Imballi / distanziatori / reggiatura', u:'lotto', p:35.00, k:0},
  {c:'Imballo/Stoccaggio', d:'Stoccaggio in piazzale', u:'giorno', p:5.00, k:0},
  {c:'Trasporti', d:'Bilico ‚Äì costo a km', u:'km', p:1.65, k:0},
  {c:'Trasporti', d:'Bilico ‚Äì costo a viaggio', u:'viaggio', p:500.00, k:0},
  {c:'Trasporti', d:'Scorta tecnica / permessi eccezionali', u:'viaggio', p:250.00, k:0},
  {c:'Trasporti', d:'Pedaggi / traghetti', u:'viaggio', p:120.00, k:0},
  {c:'Trasporti', d:'Carico camion / fissaggi', u:'lotto', p:60.00, k:0},
  {c:'Montaggio', d:'Caposquadra / preposto', u:'h', p:45.00, k:0},
  {c:'Montaggio', d:'Squadra montaggio', u:'h', p:35.00, k:0},
  {c:'Montaggio', d:'Nolo gru cantiere', u:'h', p:140.00, k:0},
  {c:'Montaggio', d:'Piattaforme aeree (PLE)', u:'h', p:65.00, k:0},
  {c:'Montaggio', d:'Attrezzature sollevamento', u:'lotto', p:150.00, k:0},
  {c:'Montaggio', d:'Bulloneria / resine / pernature', u:'lotto', p:80.00, k:0},
  {c:'Montaggio', d:'Alloggi / trasferte personale', u:'giorno', p:110.00, k:0},
  {c:'Montaggio', d:'Mezzi di supporto', u:'giorno', p:90.00, k:0},
  {c:'Spese Tecniche', d:'Progettazione esecutiva', u:'lotto', p:800.00, k:0},
  {c:'Spese Tecniche', d:'Calcoli strutturali', u:'lotto', p:1200.00, k:0},
  {c:'Spese Tecniche', d:'Direzione lavori', u:'lotto', p:1500.00, k:0},
  {c:'Generali', d:'Gestione commessa', u:'pz', p:50.00, k:0},
  {c:'Manodopera Esterni', d:'Getto Travi Rettangolari', u:'m¬≥', p:22.00, k:0},
  {c:'Manodopera Esterni', d:'Getto Travi Sezione "I"', u:'m¬≥', p:25.00, k:0},
  {c:'Manodopera Esterni', d:'Getto Pannelli', u:'m¬≥', p:20.00, k:0},
  {c:'Manodopera Esterni', d:'Lavorazione Armature', u:'kg', p:0.15, k:0},
  {c:'Manodopera Interni', d:'Pulizia', u:'h', p:22.00, k:0},
  {c:'Manodopera Altri', d:'Imprevisti / Varie', u:'lotto', p:100.00, k:0}
];

let db = JSON.parse(localStorage.getItem('acp_db_v5')) || STANDARD_ITEMS;
let charts = {}; 
let stats = { dir:0, mat:0, lab:0, ind:0, netto:0, profit:0, fixed:0 }; 

// --- TABS LOGIC ---
function switchTab(t) {
   document.querySelectorAll('.tab-content').forEach(d=>d.classList.remove('active'));
   document.querySelectorAll('.nav-tab').forEach(b=>b.classList.remove('active'));
   document.getElementById('tab-'+t).classList.add('active');
   const btns = document.querySelectorAll('.nav-tab');
   if(t==='costi') btns[0].classList.add('active');
   if(t==='bi') { btns[1].classList.add('active'); updateBiCharts(); }
   if(t==='db') { btns[2].classList.add('active'); renderDb(); updateDbChart(); }
   if(t==='info') { btns[3].classList.add('active'); updateChecklist(); }
}

// --- CALCULATION ENGINE ---
function calcTotals() {
  let totMat=0, totMan=0, totAlt=0, fixedCost=0;
  const tbody = document.getElementById('tbody');
  const rowsData = [];
  const simTarget = document.getElementById('sim-target').value;

  [...tbody.rows].forEach((tr, i) => {
     tr.querySelector('.row-idx').textContent = i+1;
     if(tr.style.display==='none') return;
     const cat = tr.querySelector('[data-key="categoria"]').textContent;
     const voce = tr.querySelector('[data-key="voce"]').textContent;
     const catL = cat.toLowerCase();
     const voceL = voce.toLowerCase();
     const q = parseSmart(tr.querySelector('[data-key="qty"]').textContent);
     const c = parseSmart(tr.querySelector('[data-key="costo"]').textContent);
     const k = parseSmart(tr.querySelector('[data-key="koc"]').textContent);
     
     let base = q * c;
     let tot = (k>0 && k<100) ? base/(1-(k/100)) : base;
     
     // Targeted Simulation Logic
     if (sensitivityFactor!==0) {
        let apply = false;
        if(simTarget === 'all') apply = true;
        else if(simTarget === 'mat' && catL.startsWith('mat')) apply = true;
        else if(simTarget === 'man' && (catL.startsWith('man') || catL.startsWith('oper'))) apply = true;
        else if(simTarget === 'tras' && catL.startsWith('tras')) apply = true;
        else if(simTarget === 'calcestruzzo' && voceL.includes('calcestruzzo')) apply = true;
        else if(simTarget === 'acciaio' && (voceL.includes('acciaio') || voceL.includes('rete'))) apply = true;
        else if(simTarget === 'trefolo' && voceL.includes('trefolo')) apply = true;
        else if(simTarget === 'trasporti_voce' && voceL.includes('bilico')) apply = true;

        if(apply) tot = tot * (1 + sensitivityFactor/100);
     }

     setNum(tr.querySelector('[data-key="tot"]'), tot, true);
     
     if(catL.startsWith('mat')) totMat += tot;
     else if(catL.startsWith('manod')||catL.startsWith('oper')) totMan += tot;
     else { 
        totAlt += tot; 
        if(catL.includes('stamp')||catL.includes('gener')||catL.includes('ammort')) fixedCost += tot; 
     }
     rowsData.push({v:tr.querySelector('[data-key="voce"]').textContent, t:tot});
  });
  
  setNum(document.getElementById('tot-mat'), totMat, true);
  setNum(document.getElementById('tot-man'), totMan, true);
  setNum(document.getElementById('tot-alt'), totAlt, true);
  const diretto = totMat + totMan + totAlt;
  setNum(document.getElementById('tot-diretto'), diretto, true);
  
  return { diretto, totMat, totMan, totAlt, fixedCost, rowsData };
}

function applySummary() {
  const { diretto, totMat, totMan, totAlt, fixedCost, rowsData } = calcTotals();
  
  const gg = parseSmart(document.getElementById('pct-gg').value);
  const imp = parseSmart(document.getElementById('pct-imp').value);
  let provv = parseSmart(document.getElementById('pct-provv').value);
  const ut = parseSmart(document.getElementById('pct-ut').value);
  let marg = parseSmart(document.getElementById('pct-margine').value);
  const iva = parseSmart(document.getElementById('pct-iva').value);
  const sconto = parseSmart(document.getElementById('pct-sconto').value);
  const pz = parseSmart(document.getElementById('pezzi').value)||1;
  const vol = parseSmart(document.getElementById('vol').value)||0;
  
  const valGG = diretto*(gg/100);
  const valIMP = (diretto+valGG)*(imp/100);
  const sub = diretto+valGG+valIMP;
  const baseDopoProvv = provv>0&&provv<100 ? sub/(1-(provv/100)) : sub;
  const valProvv = baseDopoProvv-sub;
  const valUT = baseDopoProvv*(ut/100);
  const baseDopoUtile = baseDopoProvv+valUT;
  const netto = marg>0&&marg<100 ? baseDopoUtile/(1-(marg/100)) : baseDopoUtile;
  const valMarg = netto-baseDopoUtile;
  const valIVA = netto*(iva/100);
  const totale = netto+valIVA;
  const valSconto = totale*(sconto/100);
  const totScontato = totale-valSconto;
  const margComm = totScontato>0 ? ((totScontato-sub)/totScontato)*100 : 0;

  setNum(document.getElementById('r-dir'), diretto, true);
  setNum(document.getElementById('r-gg'), valGG, true);
  setNum(document.getElementById('r-imp'), valIMP, true);
  setNum(document.getElementById('r-sub'), sub, true);
  setNum(document.getElementById('r-provv'), valProvv, true);
  setNum(document.getElementById('r-ut'), valUT, true);
  setNum(document.getElementById('r-margine'), valMarg, true);
  setNum(document.getElementById('r-netto'), netto, true);
  setNum(document.getElementById('r-iva'), valIVA, true);
  setNum(document.getElementById('r-totale'), totale, true);
  setNum(document.getElementById('r-sconto'), valSconto, true);
  setNum(document.getElementById('r-totale-sconto'), totScontato, true);
  document.getElementById('r-margine-commessa').textContent = fmt.format(safe(margComm))+' %';
  
  const totFin = totScontato;
  setNum(document.getElementById('r-per-pezzo'), totFin/pz, true);
  const mlTot = parseSmart(document.getElementById('ml-per-pezzo').value)*pz || (parseSmart(document.getElementById('len').value)*pz);
  setNum(document.getElementById('r-per-ml'), mlTot>0?totFin/mlTot:0, true);
  const mqTot = parseSmart(document.getElementById('mq-per-pezzo').value)*pz;
  setNum(document.getElementById('r-per-mq'), mqTot>0?totFin/mqTot:0, true);
  const mcTot = vol*pz;
  setNum(document.getElementById('r-per-mc'), mcTot>0?totFin/mcTot:0, true);
  setNum(document.getElementById('r-per-mc-struttura'), mcTot>0?totFin/mcTot:0, true);
  
  const weight = vol*2500;
  document.getElementById('peso').value = fmt.format(safe(weight/1000));
  
  // Update Tab 1 Charts & Cards
  document.getElementById('stat-inc-man').textContent = diretto>0 ? fmt.format(safe((totMan/diretto)*100))+'%' : '0%';
  document.getElementById('stat-eur-kg').textContent = weight>0 ? money(safe(totFin/weight)) : '0,00 ‚Ç¨';
  document.getElementById('stat-mult').textContent = diretto>0 ? fmt.format(safe(totFin/diretto))+'x' : '0x';
  
  updateChart('costPieChart', 'doughnut', ['Mat','Man','Altri'], [totMat, totMan, totAlt]);
  const sorted = rowsData.sort((a,b)=>b.t-a.t).slice(0,5);
  updateChart('categoryBarChart', 'bar', sorted.map(x=>x.v.substring(0,15)), sorted.map(x=>x.t));

  stats = { dir:diretto, mat:totMat, lab:totMan, ind:valGG+valIMP, netto, profit:valUT+valMarg+valProvv, fixed:fixedCost+valGG+valIMP, iva: valIVA };
  saveToLocal();
}

document.getElementById('sim-slider').addEventListener('input', e => {
   sensitivityFactor = parseFloat(e.target.value);
   document.getElementById('sim-val').textContent = (sensitivityFactor>0?'+':'')+sensitivityFactor+'%';
   applySummary();
});

// --- BI TAB UPDATES (ENHANCED) ---
function updateBiCharts() {
   // Force update from inputs to ensure consistency even if not switched recently
   applySummary();
   
   const pz = parseSmart(document.getElementById('pezzi').value)||1;
   const pricePerUnit = stats.netto / pz;
   const vc = stats.mat + stats.lab;
   const cm = stats.netto - vc; // Contribution Margin
   const fc = stats.fixed + (stats.dir * 0.05); // Estimated fixed portion
   
   const bep = (pricePerUnit - (vc/pz)) > 0 ? Math.ceil(fc / (pricePerUnit - (vc/pz))) : 0;
   const costBase = stats.ind + stats.dir;
   const roi = costBase>0 ? (stats.profit/costBase)*100 : 0;
   
   // New KPIs
   const bep_val = bep * pricePerUnit;
   const safetyMargin = stats.netto > 0 ? ((stats.netto - bep_val) / stats.netto) * 100 : 0;
   const markup = stats.dir > 0 ? ((stats.netto - stats.dir) / stats.dir) * 100 : 0;

   document.getElementById('bi-mc').textContent = money(safe(cm/pz));
   document.getElementById('bi-bep').textContent = safe(bep);
   document.getElementById('bi-roi').textContent = safe(roi).toFixed(1)+'%';
   document.getElementById('bi-fixed').textContent = money(safe(fc));
   document.getElementById('bi-safe').textContent = safe(safetyMargin).toFixed(1)+'%';
   document.getElementById('bi-markup').textContent = safe(markup).toFixed(1)+'%';

   // 1. Radar Chart (Existing)
   updateChart('radarChart', 'radar', ['Materiali','Manodopera','Indiretti','Profitto'], [stats.mat, stats.lab, stats.ind, stats.profit]);
   
   // 2. BEP Chart (Existing)
   const tgt = pz*2;
   updateChart('beChart', 'line', ['0','BEP','Target'], 
      [{l:'Ricavi',d:[0, safe(bep*pricePerUnit), safe(tgt*pricePerUnit)],c:'#2dd4bf'}, {l:'Costi',d:[safe(fc), safe(fc+(bep*(vc/pz))), safe(fc+(tgt*(vc/pz)))],c:'#ef4444'}], true);

   // 3. Price Waterfall (New)
   updateChart('waterfallChart', 'bar', 
      ['Costo Diretto', 'Spese Generali', 'Imprevisti', 'Utile + Margine', 'Tasse (IVA)', 'Prezzo Finale'], 
      [stats.dir, stats.ind * 0.8, stats.ind * 0.2, stats.profit, stats.iva, stats.netto + stats.iva], 
      false, 
      ['#38bdf8', '#fbbf24', '#f87171', '#4ade80', '#94a3b8', '#a855f7']
   );

   // 4. Profitability Doughnut (New)
   updateChart('profitabilityChart', 'doughnut', 
      ['Costi Totali', 'Margine Netto'], 
      [costBase, stats.profit],
      false,
      ['#1e293b', '#4ade80']
   );
}

// --- DB & CHECKLIST ---
function renderDb() {
   const c = document.getElementById('db-list'); c.innerHTML='';
   db.forEach((i,x) => {
      c.innerHTML += `<div class="db-row">
         <input value="${i.c}" onchange="db[${x}].c=this.value;saveDb();updateDbChart()">
         <input value="${i.d}" onchange="db[${x}].d=this.value;saveDb()">
         <input class="right" value="${i.u}" onchange="db[${x}].u=this.value;saveDb()">
         <input class="right" type="number" value="${i.p}" onchange="db[${x}].p=parseFloat(this.value);saveDb()">
         <input class="right" type="number" value="${i.k}" onchange="db[${x}].k=parseFloat(this.value);saveDb()">
         <button class="btn-warn btn-sm" onclick="db.splice(${x},1);renderDb();saveDb();updateDbChart()">X</button>
      </div>`;
   });
}
function updateDbChart() {
   const cats = {}; db.forEach(i => cats[i.c] = (cats[i.c]||0)+1);
   updateChart('dbPieChart', 'doughnut', Object.keys(cats), Object.values(cats));
}
function addDbItem() { db.unshift({c:'Generico',d:'Nuova',u:'pz',p:0,k:0}); renderDb(); saveDb(); updateDbChart(); }
function saveDb() { localStorage.setItem('acp_db_v5', JSON.stringify(db)); }
function updateChecklist() {
   const all = document.querySelectorAll('#checklist-container input[type="checkbox"]');
   const chk = document.querySelectorAll('#checklist-container input[type="checkbox"]:checked');
   const pct = all.length > 0 ? Math.round((chk.length/all.length)*100) : 0;
   document.getElementById('checklist-text').textContent = pct + '%';
   updateChart('checklistChart', 'doughnut', ['Fatto','Da fare'], [pct, 100-pct], false, ['#2dd4bf','#1e293b']);
}

// --- CHART HANDLER ---
function updateChart(id, type, labels, data, complex=false, colors=null) {
   if(charts[id]) charts[id].destroy();
   const ctx = document.getElementById(id).getContext('2d');
   let scales = {};
   let idxAxis = 'x';
   if (type === 'bar') { idxAxis = 'x'; scales = { y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' } }, x: { grid: { color: 'rgba(255,255,255,0.05)' } } }; } 
   else if (type === 'line') { scales = { y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' } }, x: { grid: { color: 'rgba(255,255,255,0.05)' } } }; } 
   else if (type === 'radar') { scales = { r: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.1)' }, pointLabels: { color: '#e2e8f0' }, ticks: { display: false, backdropColor: 'transparent' } } }; }
   const cfg = {
      type: type,
      data: {
         labels: labels,
         datasets: complex ? data.map(d=>({label:d.l, data:d.d, borderColor:d.c, backgroundColor:d.c, tension:0.1})) : 
         [{ data: data, backgroundColor: colors || ['#38bdf8','#fbbf24','#4ade80','#a855f7'], borderWidth:0, borderRadius:6 }]
      },
      options: { 
         indexAxis: idxAxis, 
         responsive:true, 
         maintainAspectRatio:false, 
         plugins:{ 
             legend:{ display: complex || type==='doughnut', labels: { color: '#cbd5e1' } } 
         }, 
         scales: scales 
      }
   };
   charts[id] = new Chart(ctx, cfg);
}

// --- GRID & MODALS ---
function addRow(data={}) {
  const tpl = document.getElementById('row-template');
  const tr = tpl.content.firstElementChild.cloneNode(true);
  const keys = ['categoria','voce','qty','um','costo','koc','tot','note'];
  keys.forEach(k => {
    const cell = tr.querySelector(`[data-key="${k}"]`);
    if(!cell) return;
    if(data[k]) cell.textContent = k==='costo'||k==='qty'||k==='koc' ? fmt.format(safe(data[k])) : data[k];
    else if(k==='categoria') cell.textContent = 'Materiali';
    else if(k==='qty'||k==='costo'||k==='koc') cell.textContent = '0';
  });
  document.getElementById('tbody').appendChild(tr);
  applySummary();
}
function delRow() { const s = document.querySelector('.grid tr.sel'); if(s) s.remove(); applySummary(); }
function dupRow() { 
   const s = document.querySelector('.grid tr.sel'); 
   if(s) { 
      const d={}; ['categoria','voce','qty','um','costo','koc','note'].forEach(k => d[k]=s.querySelector(`[data-key="${k}"]`).textContent);
      d.costo = parseSmart(d.costo); d.qty = parseSmart(d.qty); d.koc = parseSmart(d.koc);
      addRow(d); 
   } 
}
document.getElementById('tbody').addEventListener('click', e => {
   const tr = e.target.closest('tr'); if(tr) { document.querySelectorAll('.grid tr').forEach(r=>r.classList.remove('sel')); tr.classList.add('sel'); }
});
document.getElementById('tbody').addEventListener('input', applySummary);

// --- FUNCTIONS DEFINITIONS ---
window.resetData = () => { 
   document.getElementById('tbody').innerHTML=''; 
   addRow(); // Add one empty row
   applySummary(); 
}

window.seedDefaults = () => {
   document.getElementById('tbody').innerHTML='';
   STANDARD_ITEMS.forEach(d=>addRow({categoria:d.c, voce:d.d, um:d.u, costo:d.p, koc:d.k, qty:0}));
   applySummary();
}

// --- CATALOG LOGIC (FIXED) ---
document.getElementById('btn-catalog').onclick = () => {
   const c = document.getElementById('modal-db-list'); 
   c.innerHTML='';
   db.forEach(i => {
      const d = document.createElement('div'); d.className='catalog-item';
      d.innerHTML = `<span style="color:var(--acc)">${i.c}</span> <b>${i.d}</b> <span>${i.p} ‚Ç¨/${i.u}</span>`;
      d.setAttribute('data-search', (i.c+i.d).toLowerCase());
      d.onclick = () => { addRow({categoria:i.c, voce:i.d, um:i.u, costo:i.p, koc:i.k, qty:1}); document.getElementById('cat-modal').style.display='none'; };
      c.appendChild(d);
   });
   document.getElementById('cat-modal').style.display='flex';
}

document.getElementById('cat-search').addEventListener('keyup', (e) => {
    const val = e.target.value.toLowerCase();
    document.querySelectorAll('#modal-db-list .catalog-item').forEach(el => {
        el.style.display = el.getAttribute('data-search').includes(val) ? 'flex' : 'none';
    });
});

document.getElementById('btn-geom-calc').onclick = () => { document.getElementById('custom-modal').classList.add('active'); 
   const html = `<div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
       <div class="col"><label>Tipo</label><select id="gc-type" onchange="toggleGeo()"><option value="rect">Rettangolare</option><option value="ibeam">Trave I</option></select></div>
       <div class="col"><label>L (m)</label><input id="gc-l" type="number"></div>
       <div class="col"><label>Base (m)</label><input id="gc-b" type="number"></div>
       <div class="col"><label>Altezza (m)</label><input id="gc-h" type="number"></div>
       <div class="col" id="gc-ex" style="display:none"><label>Anima/Sup</label><input id="gc-tw" type="number" placeholder="spessore"></div>
   </div>`;
   showCustomModal("Calcolatrice", html, () => {
      const l = parseFloat(document.getElementById('gc-l').value)||0;
      const b = parseFloat(document.getElementById('gc-b').value)||0;
      const h = parseFloat(document.getElementById('gc-h').value)||0;
      let area = b*h; 
      if(document.getElementById('gc-type').value === 'ibeam') area = (b*0.2) + (b*0.2) + (0.2*(h-0.4)); 
      document.getElementById('vol').value = (area*l).toFixed(3);
      document.getElementById('len').value = l; document.getElementById('wid').value = b; document.getElementById('hei').value = h;
      applySummary();
   });
}
window.toggleGeo = () => { document.getElementById('gc-ex').style.display = document.getElementById('gc-type').value==='ibeam'?'block':'none'; }

// Modal Helpers
const modal = document.getElementById('custom-modal');
const mTitle = document.getElementById('modal-title');
const mContent = document.getElementById('modal-content');
const mYes = document.getElementById('modal-confirm');
const mNo = document.getElementById('modal-cancel');
let currentCallback = null;
function showCustomModal(title, html, callback) {
   mTitle.textContent = title; mContent.innerHTML = html;
   currentCallback = callback; mYes.style.display = 'block'; mYes.textContent = 'Applica'; mNo.onclick=closeModal;
   modal.classList.add('active');
}
function closeModal() { modal.classList.remove('active'); currentCallback=null; }
mYes.onclick = () => { if(currentCallback) currentCallback(); closeModal(); };

// --- FILE IO ---
function saveToLocal() { localStorage.setItem('acp_sticky_v54', JSON.stringify(getSnapshot())); }
function getSnapshot() {
   const rows = [...document.querySelectorAll('#tbody tr')].map(tr => {
      const d={}; ['categoria','voce','qty','um','costo','koc','note'].forEach(k=>d[k]=tr.querySelector(`[data-key="${k}"]`).textContent); return d;
   });
   const inputs={}; document.querySelectorAll('input, select').forEach(el=>{if(el.id) inputs[el.id]=el.value});
   return {rows, inputs};
}
function restoreSnapshot(data) {
   if(data.inputs) for(const k in data.inputs) if(document.getElementById(k)) document.getElementById(k).value=data.inputs[k];
   document.getElementById('tbody').innerHTML='';
   if(data.rows) data.rows.forEach(r=>addRow(r)); else seedDefaults();
   applySummary();
}
document.getElementById('btn-export-xlsx').onclick = () => {
   const wb = XLSX.utils.book_new();
   const rows = [['Categoria','Voce','Qta','Costo','Totale']];
   [...document.getElementById('tbody').rows].forEach(tr => rows.push([tr.cells[1].textContent, tr.cells[2].textContent, tr.cells[3].textContent, tr.cells[5].textContent, tr.cells[7].textContent]));
   XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(rows), "Analisi");
   XLSX.writeFile(wb, "Analisi.xlsx");
};
document.getElementById('btn-import-xlsx').onclick = () => document.getElementById('file-import-xlsx').click();
document.getElementById('file-import-xlsx').onchange = async (e) => {
   const f = e.target.files[0]; if(!f) return; const d = await f.arrayBuffer(); const wb = XLSX.read(d);
   const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
   document.getElementById('tbody').innerHTML=''; json.forEach(r=>addRow({categoria:r.Categoria||r.A, voce:r.Voce||r.B, qty:r.Qta||r.C, costo:r.Costo||r.D}));
};
window.saveScenario = (id) => { localStorage.setItem('acp_sc_'+id, JSON.stringify(getSnapshot())); alert('Scenario '+id+' salvato'); }
window.loadScenario = (id) => { const s=localStorage.getItem('acp_sc_'+id); if(s) restoreSnapshot(JSON.parse(s)); else alert('Vuoto'); }

// --- FIXED ABACHI BUTTON ---
document.getElementById('btn-abachi').onclick = () => document.getElementById('abachi-card').style.display='block';

// --- NEW LISTENER BLOCK ---
// Attach listeners to inputs for real-time updates
const inputsToWatch = [
  'job-name', 'job-date', 'sup-mont', 'sup-pan', 'el-type', 'el-desc',
  'pct-gg', 'pct-imp', 'pct-provv', 'pct-ut', 'pct-margine', 'pct-iva', 'pct-sconto',
  'pezzi', 'ml-per-pezzo', 'mq-per-pezzo',
  'len', 'wid', 'hei', 'vol'
];
inputsToWatch.forEach(id => {
  const el = document.getElementById(id);
  if(el) el.addEventListener('input', applySummary);
});

// --- CONNECT BUTTONS (FIXED ORDER) ---
document.getElementById('add-row').onclick = () => addRow();
document.getElementById('dup-row').onclick = dupRow;
document.getElementById('del-row').onclick = delRow;
document.getElementById('btn-calc').onclick = applySummary;
// Important: Assign these AFTER the functions are defined
document.getElementById('btn-reset').onclick = window.resetData;
document.getElementById('btn-seed').onclick = window.seedDefaults;

// --- INIT ---
window.onload = () => {
   // Restore or Seed
   const s = localStorage.getItem('acp_sticky_v54');
   if(s) restoreSnapshot(JSON.parse(s)); else seedDefaults();
   
   // Init Charts
   updateChart('costPieChart', 'doughnut', ['A','B'], [1,1]); 
   applySummary(); 
   updateDbChart();
   updateChecklist();
   
   document.getElementById('btn-save-as').onclick = () => {
      const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([document.documentElement.outerHTML], {type:'text/html'})); a.download='Analisi.html'; a.click();
   };
}
</script>
</body>
</html>
