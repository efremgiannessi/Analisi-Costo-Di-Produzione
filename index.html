<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Analisi Costo di Produzione ‚Äî Ultimate V4.1</title>
  
  <!-- SheetJS per Excel -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <!-- Chart.js per Grafici -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --bg:#0b0f14; --panel:#121821; --muted:#1b2430; 
      --ink:#e7edf3; --ink-2:#b7c2cf; 
      --acc:#4cc9f0; --ok:#2dd4bf; --warn:#f59e0b; --err:#ef4444; 
      --grid:#263042; 
      --shadow: 0 8px 24px rgba(0,0,0,.4);
      
      /* Z-Index Layers */
      --z-modal: 2000;
      --z-toolbar: 100;
      --z-thead: 90;
    }

    * { box-sizing:border-box; }
    html,body { height:100%; margin:0; padding:0; }
    
    body {
      background: linear-gradient(180deg,#0b0f14,#0c121b 60%,#0b0f14);
      color: var(--ink);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, sans-serif;
      font-size: 14px;
      line-height: 1.45;
    }

    .wrap { max-width:1280px; margin:0 auto; padding:16px; padding-bottom: 80px; }
    
    /* Utility Classes */
    .card { background:var(--panel); border:1px solid var(--grid); border-radius:16px; box-shadow:var(--shadow); overflow:hidden; }
    .pad { padding:16px; }
    .h { display:flex; gap:12px; align-items:center; }
    .row { display:grid; grid-template-columns:repeat(12,1fr); gap:12px; }
    .col { display:flex; flex-direction:column; gap:4px; }
    .hr { height:1px; background:linear-gradient(90deg,transparent,#263042,transparent); margin:16px 0; }
    .right { text-align:right; }
    .num { font-variant-numeric: tabular-nums; font-family: "Consolas", monospace; letter-spacing: -0.5px; }
    .muted { color:var(--ink-2); }
    .small { font-size:12px; }
    .nowrap { white-space:nowrap; }
    .soft { opacity:.7; }
    .hidden { display:none !important; }

    /* Typography */
    h1 { font-size:20px; margin:0; font-weight:700; color:var(--ink); }
    h2 { font-size:16px; margin:0 0 12px; color:var(--acc); font-weight:600; text-transform:uppercase; letter-spacing:1px; }

    /* Inputs & Form Elements */
    input, select, textarea {
      width:100%; background:#0f1520; border:1px solid var(--grid); color:var(--ink);
      padding:8px 10px; border-radius:8px; outline:none; transition: all 0.2s;
    }
    input:focus, select:focus { border-color:var(--acc); box-shadow:0 0 0 2px rgba(76,201,240,.15); }
    label { font-size:11px; color:var(--ink-2); font-weight:600; text-transform:uppercase; }

    /* Buttons */
    button, .btn {
      background:#192233; border:1px solid var(--grid); color:var(--ink);
      padding:8px 14px; border-radius:8px; cursor:pointer; font-size:13px; font-weight:500;
      transition: background 0.2s;
    }
    button:hover { background:#2a3649; border-color:#35507c; }
    .btn-primary { background:var(--acc); color:#000; border-color:var(--acc); font-weight:700; }
    .btn-primary:hover { background:#2ac0eb; }
    .btn-acc { background:rgba(76,201,240,0.1); border-color:var(--acc); color:var(--acc); }
    .btn-acc:hover { background:rgba(76,201,240,0.2); }
    .btn-ok { background:rgba(45,212,191,0.1); border-color:var(--ok); color:var(--ok); }
    .btn-ok:hover { background:rgba(45,212,191,0.2); }
    .btn-warn { background:rgba(245,158,11,0.1); border-color:var(--warn); color:var(--warn); }
    .btn-icon { padding: 8px; width: 36px; text-align: center; }
    
    /* --- LAYOUT FIX --- */
    .topbar {
      position: relative; 
      background: linear-gradient(180deg,#131a24 0%,#0f1621 100%);
      border: 1px solid var(--grid); border-radius: 12px;
      box-shadow: var(--shadow);
      margin-bottom: 16px;
      padding: 12px 16px;
    }
    
    .projbar {
      display:grid; grid-template-columns:repeat(12,1fr); gap:10px;
      margin-top:12px; padding-top:12px; border-top:1px dashed var(--grid);
    }

    /* Table & Grid */
    .table-container { position:relative; overflow:visible; }
    
    .cost-head-sticky {
      position: sticky; 
      top: 0; 
      z-index: var(--z-toolbar);
      background: #121821; 
      border-bottom: 1px solid var(--grid);
      padding: 12px 16px;
      display: flex; justify-content: space-between; align-items: center;
      margin: 0 -16px; 
      width: calc(100% + 32px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }

    table.grid { width:100%; border-collapse:separate; border-spacing:0; }
    .grid th, .grid td { border-bottom:1px dashed var(--grid); padding:8px 10px; vertical-align:middle; }
    .grid th { text-align:left; font-weight:600; color:var(--ink-2); font-size:12px; text-transform:uppercase; }
    
    .grid thead th {
      position: sticky;
      top: 65px; 
      z-index: var(--z-thead);
      background: #151d28; 
      border-bottom: 2px solid var(--grid);
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .grid tbody tr:hover { background:rgba(255,255,255,0.03); }
    .grid tbody tr.sel { background:rgba(76,201,240,0.1); }
    
    [contenteditable] { cursor:text; border-radius:4px; padding:2px 4px; }
    [contenteditable]:focus { background:#000; outline:1px solid var(--acc); color:var(--acc); }

    /* Totals Footer */
    .grid tfoot th { text-align:right; color:var(--ink-2); padding-top:12px; border-bottom:none; }
    .grid tfoot td, .grid tfoot .num { font-size:15px; font-weight:700; color:var(--ink); border-bottom:none; padding-top:12px; }

    /* Key-Value Grid for Summary */
    .kv-grid { display:grid; grid-template-columns: 1fr 120px; gap:8px 16px; align-items:center; }
    .kv-grid label { font-size:12px; color:var(--ink-2); font-weight:normal; text-transform:none; }
    .kv-grid .val { text-align:right; font-family:"Consolas", monospace; font-size:13px; }

    /* Calc Float Button */
    #btn-calc-fixed {
      position:fixed; bottom:24px; right:24px; z-index:999;
      background:var(--acc); color:#000; 
      width:56px; height:56px; border-radius:50%;
      display:flex; align-items:center; justify-content:center;
      font-size:24px; box-shadow:0 10px 30px rgba(76,201,240,0.4);
      border:none; cursor:pointer; transition:transform 0.2s;
    }
    #btn-calc-fixed:hover { transform:scale(1.1); }
    #btn-calc-fixed:active { transform:scale(0.95); }

    /* Abachi Tabs */
    #abachi-tabs { display:flex; gap:8px; overflow-x:auto; padding-bottom:8px; border-bottom:1px solid var(--grid); margin-bottom:12px; }
    #abachi-tabs button { white-space:nowrap; }
    #abachi-tabs button.active { background:var(--acc); color:#000; border-color:var(--acc); }
    #abachi-host .sheet { display:none; max-height:500px; overflow:auto; background:#fff; color:#000; padding:16px; border-radius:8px; }
    #abachi-host .sheet.active { display:block; }
    #abachi-host table { border-collapse:collapse; width:100%; font-size:12px; }
    #abachi-host td, #abachi-host th { border:1px solid #ccc; padding:4px; }

    /* Custom Modal */
    .modal-overlay { 
      position:fixed; top:0; left:0; width:100%; height:100%; 
      background:rgba(0,0,0,0.7); backdrop-filter:blur(4px);
      z-index: var(--z-modal); display:flex; align-items:center; justify-content:center;
      opacity:0; pointer-events:none; transition:opacity 0.2s ease-out;
    }
    .modal-overlay.active { opacity:1; pointer-events:all; }
    .modal { 
      background:#161f2b; border:1px solid var(--grid); 
      padding:24px; border-radius:16px; max-width:420px; width:90%; 
      box-shadow:0 25px 50px rgba(0,0,0,0.6); 
      transform:translateY(20px); transition:transform 0.2s ease-out;
      display:flex; flex-direction:column; gap:12px;
    }
    .modal-overlay.active .modal { transform:translateY(0); }
    .modal h3 { margin:0; color:var(--ink); font-size:18px; }
    .modal p { color:var(--ink-2); line-height:1.5; margin:0; }
    .modal-actions { display:flex; justify-content:flex-end; gap:12px; margin-top:12px; }
    
    /* Catalog List Style inside Modal */
    .catalog-list { max-height:300px; overflow-y:auto; border:1px solid var(--grid); border-radius:8px; margin-top:8px; }
    .catalog-item { padding:8px; border-bottom:1px solid var(--grid); cursor:pointer; display:flex; justify-content:space-between; }
    .catalog-item:hover { background:var(--muted); }
    .catalog-item:last-child { border-bottom:none; }

    /* Stat Cards */
    .stat-card {
      background: #151d28; border: 1px solid var(--grid);
      border-radius: 12px; padding: 12px; display:flex; flex-direction:column; gap:4px;
    }
    .stat-val { font-size:20px; font-weight:bold; color:#fff; }
    .stat-lbl { font-size:11px; color:var(--ink-2); text-transform:uppercase; letter-spacing:0.5px; }

    /* --- PRINT STYLES (NEW) --- */
    @media print {
      body { background: #fff !important; color: #000 !important; font-family: "Times New Roman", serif; font-size: 11pt; }
      .wrap { max-width: 100% !important; margin: 0; padding: 0; }
      .card { border: none !important; box-shadow: none !important; border-radius: 0 !important; background: none !important; margin-bottom: 20px !important; }
      /* Hide UI Elements */
      .topbar button, .cost-head-sticky, #btn-calc-fixed, 
      .modal-overlay, #abachi-card, #scenarios-card, .stat-card, canvas, #btn-save-as { display: none !important; }
      .topbar { border:none; box-shadow:none; background:none; padding:0; margin-bottom:10px; }
      .projbar { border-top: 1px solid #000; padding-top: 10px; margin-top: 10px; }
      input, select, textarea { border: none !important; background: none !important; color: #000 !important; padding: 0 !important; font-weight: bold; width: auto !important; -webkit-appearance: none; }
      label { color: #444 !important; font-size: 9pt; }
      table.grid { width: 100%; border-collapse: collapse; border: 1px solid #000; }
      .grid th, .grid td { border: 1px solid #ccc !important; padding: 4px; color: #000 !important; }
      .grid thead th { background: #eee !important; color: #000 !important; position: static !important; }
      /* Force Colors */
      #r-totale, #r-netto { color: #000 !important; }
      /* Hide "Statistiche Avanzate" title if card is hidden */
      h2 { color: #000 !important; border-bottom: 1px solid #000; padding-bottom: 4px; }
      /* Footer */
      .footer-print { display: block !important; text-align: center; font-size: 9pt; margin-top: 30px; border-top: 1px solid #000; padding-top: 10px; }
    }
    .footer-print { display: none; }

    @media (max-width: 900px) {
       .projbar { grid-template-columns: repeat(2, 1fr); }
       .row { display:flex; flex-direction:column; }
       @media (max-height: 500px) {
         .cost-head-sticky, .grid thead th { position:static; }
       }
    }
  </style>
</head>
<body>

<!-- Floating Calc Button -->
<button id="btn-calc-fixed" title="Calcola">üßÆ</button>

<!-- CUSTOM MODAL HTML -->
<div id="custom-modal" class="modal-overlay">
  <div class="modal">
    <h3 id="modal-title">Titolo</h3>
    <div id="modal-content">
       <p id="modal-msg">Messaggio...</p>
    </div>
    <div class="modal-actions">
      <button id="modal-cancel" class="btn">Chiudi</button>
      <button id="modal-confirm" class="btn-primary" style="display:none">Conferma</button>
    </div>
  </div>
</div>

<div class="wrap">

  <!-- TOPBAR -->
  <div class="topbar">
    <div class="h" style="justify-content:space-between">
       <div class="h">
         <div style="background:var(--acc); color:#000; font-weight:bold; padding:4px 8px; border-radius:6px; font-size:12px;">V4.1 Ultimate</div>
         <h1>Analisi Costo</h1>
       </div>
       <div class="h">
         <button id="btn-calc" class="btn-acc">Calcola</button>
         <button id="btn-print" class="btn">üñ®Ô∏è Stampa</button>
         <button id="btn-save" class="btn-primary">Salva</button>
       </div>
    </div>
    
    <div class="projbar">
       <div class="col" style="grid-column: span 4">
          <label>Nome Commessa</label>
          <input id="job-name" type="text" placeholder="Es. Capannone Logistica MI" />
       </div>
       <div class="col" style="grid-column: span 2">
          <label>Data</label>
          <input id="job-date" type="date" />
       </div>
       <div class="col" style="grid-column: span 2">
          <label>Sup. Montaggio (m¬≤)</label>
          <input id="sup-mont" type="text" class="num right" placeholder="0,00" />
       </div>
       <div class="col" style="grid-column: span 2">
          <label>Sup. Pannelli (m¬≤)</label>
          <input id="sup-pan" type="text" class="num right" placeholder="0,00" />
       </div>
    </div>
  </div>

  <!-- GEOMETRIA ELEMENTO -->
  <div class="card pad" style="margin-bottom:16px;">
    <div class="h" style="justify-content:space-between">
       <h2>Dati Elemento</h2>
       <button id="btn-geom-calc" class="btn small btn-icon" title="Calcolatrice Geometrica Avanzata">üìê</button>
    </div>
    <div class="row">
       <div class="col" style="grid-column: span 3">
          <label>Tipologia</label>
          <select id="el-type">
             <option value="Elemento precompresso">Struttura / Trave</option>
             <option value="Pannello precompresso">Pannello / Tamponamento</option>
             <option value="Altra tipologia">Generico</option>
          </select>
       </div>
       <div class="col" style="grid-column: span 4">
          <label>Descrizione Elemento</label>
          <input id="el-desc" placeholder="es. Trave I 80x120 L=20m" />
       </div>
       <div class="col" style="grid-column: span 1">
          <label>L (m)</label>
          <input id="len" type="number" step="0.01" class="right" />
       </div>
       <div class="col" style="grid-column: span 1">
          <label>B (m)</label>
          <input id="wid" type="number" step="0.01" class="right" />
       </div>
       <div class="col" style="grid-column: span 1">
          <label>H (m)</label>
          <input id="hei" type="number" step="0.01" class="right" />
       </div>
       <div class="col" style="grid-column: span 1">
          <label>Vol (m¬≥)</label>
          <input id="vol" type="number" step="0.001" class="right" style="border-color:var(--acc)" />
       </div>
       <div class="col" style="grid-column: span 1">
          <label>Peso (t)</label>
          <input id="peso" type="text" readonly class="muted right" tabindex="-1" />
       </div>
    </div>
  </div>

  <!-- TABELLA COSTI -->
  <div class="card pad table-container" style="margin-bottom:16px;">
    <div class="cost-head-sticky">
       <div class="h">
         <h2>Voci di Costo</h2>
         <select id="filter-cat" style="width:180px; height:32px; padding:0 8px;">
            <option value="">Tutte le categorie</option>
            <option>Materiali</option>
            <option>Manodopera</option>
            <option>Trasporti</option>
            <option>Montaggio</option>
            <option>Esterni</option>
         </select>
       </div>
       <div class="h">
         <button id="btn-catalog" class="btn-acc">üìö Catalogo</button>
         <div style="width:1px;height:20px;background:var(--grid)"></div>
         <button id="add-row" class="btn">Aggiungi</button>
         <button id="dup-row" class="btn">Duplica</button>
         <button id="del-row" class="btn-warn">Elimina</button>
       </div>
    </div>

    <table class="grid" id="cost-grid">
       <thead>
          <tr>
             <th style="width:40px; text-align:center">#</th>
             <th style="width:140px">Categoria</th>
             <th>Descrizione Voce</th>
             <th class="right" style="width:80px">Q.t√†</th>
             <th style="width:60px">UM</th>
             <th class="right" style="width:100px">Costo Unit.</th>
             <th class="right" style="width:80px">K o.c. %</th>
             <th class="right" style="width:110px">Totale</th>
             <th style="width:150px">Note</th>
          </tr>
       </thead>
       <tbody id="tbody">
          <!-- Righe generate via JS -->
       </tbody>
       <tfoot>
          <tr>
             <td colspan="7" class="right muted">Totale Materiali</td>
             <td class="right num" id="tot-mat">0,00 ‚Ç¨</td>
             <td></td>
          </tr>
          <tr>
             <td colspan="7" class="right muted">Totale Manodopera</td>
             <td class="right num" id="tot-man">0,00 ‚Ç¨</td>
             <td></td>
          </tr>
          <tr>
             <td colspan="7" class="right muted">Totale Altri (Noli, Trasporti, Montaggio...)</td>
             <td class="right num" id="tot-alt">0,00 ‚Ç¨</td>
             <td></td>
          </tr>
          <tr>
             <td colspan="7" class="right" style="font-size:16px; color:var(--acc)">COSTO DIRETTO DI PRODUZIONE</td>
             <td class="right num" id="tot-diretto" style="font-size:16px; color:var(--acc); border-top:1px solid var(--grid)">0,00 ‚Ç¨</td>
             <td></td>
          </tr>
       </tfoot>
    </table>
    <div class="small muted" style="margin-top:8px;">
       Doppio click sulle celle per modificare. "K o.c." √® il coefficiente opere complementari.
    </div>
  </div>

  <!-- RIEPILOGO E PARAMETRI -->
  <div class="card pad">
     <div class="row" style="grid-template-columns: 1fr 1fr; gap:24px;">
        <div class="col">
           <h2>Parametri economici</h2>
           <div class="kv-grid">
              <label>Spese generali (%)</label>
              <input id="pct-gg" class="right" value="8" />
              
              <label>Imprevisti (%)</label>
              <input id="pct-imp" class="right" value="2" />
              
              <label>Provvigione (%) <span class="muted small">(ricarico inverso)</span></label>
              <input id="pct-provv" class="right" value="0" />
              
              <label>Utile (%)</label>
              <input id="pct-ut" class="right" value="10" />
              
              <label>Margine di profitto (%) <span class="muted small">(ricarico inverso)</span></label>
              <input id="pct-margine" class="right" value="30" />
              
              <label>IVA (%)</label>
              <input id="pct-iva" class="right" value="22" />
              
              <label>Sconto (%)</label>
              <input id="pct-sconto" class="right" value="0" />
              
              <div class="hr" style="grid-column:span 2; margin:8px 0;"></div>
              
              <label>Produzione/lotto (pezzi)</label>
              <input id="pezzi" class="right" value="1" />
              
              <label>Metri lineari per pezzo (m)</label>
              <input id="ml-per-pezzo" class="right" value="0" />
              
              <label>Metri quadrati per pezzo (m¬≤)</label>
              <input id="mq-per-pezzo" class="right" value="0" />
           </div>
        </div>

        <div class="col" style="border-left:1px solid var(--grid); padding-left:24px;">
           <h2>Riepilogo</h2>
           <div class="kv-grid">
              <label>Costo diretto</label>
              <div class="val" id="r-dir">0,00 ‚Ç¨</div>
              
              <label class="muted small">+ Spese generali</label>
              <div class="val" id="r-gg">0,00 ‚Ç¨</div>
              
              <label class="muted small">+ Imprevisti</label>
              <div class="val" id="r-imp">0,00 ‚Ç¨</div>
              
              <label style="color:var(--ink); font-weight:bold">Subtotale industriale</label>
              <div class="val" id="r-sub" style="font-weight:bold; border-top:1px solid var(--grid)">0,00 ‚Ç¨</div>
              
              <label class="muted small">+ Provvigione (ricarico)</label>
              <div class="val" id="r-provv">0,00 ‚Ç¨</div>
              
              <label class="muted small">+ Utile</label>
              <div class="val" id="r-ut">0,00 ‚Ç¨</div>
              
              <label class="muted small">+ Margine di profitto (ricarico)</label>
              <div class="val" id="r-margine">0,00 ‚Ç¨</div>
              
              <label style="color:var(--ink)">Prezzo netto</label>
              <div class="val" id="r-netto">0,00 ‚Ç¨</div>
              
              <label class="muted small">+ IVA</label>
              <div class="val" id="r-iva">0,00 ‚Ç¨</div>
              
              <label style="font-size:18px; font-weight:bold; color:var(--ink)">Prezzo totale</label>
              <div class="val" id="r-totale" style="font-size:18px; font-weight:bold; color:var(--ink)">0,00 ‚Ç¨</div>
              
              <label class="muted small">‚Äì Sconto</label>
              <div class="val" id="r-sconto">0,00 ‚Ç¨</div>
              
              <label style="font-size:18px; font-weight:bold; color:var(--ink)">Totale scontato</label>
              <div class="val" id="r-totale-sconto" style="font-size:18px; font-weight:bold; color:var(--ink)">0,00 ‚Ç¨</div>
              
              <label class="muted small">Margine commessa (%)</label>
              <div class="val" id="r-margine-commessa">0,00 %</div>
           </div>
           
           <div class="hr"></div>
           
           <div class="kv-grid">
              <label>Prezzo / pezzo</label>
              <div class="val" id="r-per-pezzo">0,00 ‚Ç¨</div>
              
              <label>Prezzo / m lineare</label>
              <div class="val" id="r-per-ml">0,00 ‚Ç¨</div>
              
              <label>Prezzo / m¬≤</label>
              <div class="val" id="r-per-mq">0,00 ‚Ç¨</div>
              
              <label>Prezzo / m¬≥</label>
              <div class="val" id="r-per-mc">0,00 ‚Ç¨</div>
              
              <label>Prezzo Struttura / m¬≥</label>
              <div class="val" id="r-per-mc-struttura">0,00 ‚Ç¨</div>
           </div>
        </div>
     </div>
  </div>

  <!-- STATISTICHE E GRAFICI (Con Simulatore "What-If") -->
  <div class="card pad" style="margin-top:16px;">
     <div class="h" style="justify-content:space-between">
        <h2>Statistiche & Simulazione</h2>
        <div class="pill small muted" style="border:1px solid var(--warn); padding:4px 8px; border-radius:4px; color:var(--warn)">
           Simulazione attiva: Costi materiali <span id="sim-display">+0%</span>
        </div>
     </div>
     
     <div class="row">
        <!-- Torta Costi -->
        <div class="col" style="grid-column: span 4; align-items:center;">
           <div style="height:250px; width:100%; position:relative;">
              <canvas id="costPieChart"></canvas>
           </div>
        </div>
        
        <!-- KPI Cards + Slider Simulazione -->
        <div class="col" style="grid-column: span 8;">
           
           <!-- Slider What-If -->
           <div style="background:#192233; padding:12px; border-radius:12px; margin-bottom:12px; border:1px solid var(--grid)">
              <div class="h" style="justify-content:space-between; margin-bottom:4px">
                 <label style="color:var(--warn)">Simula Variazione Costo Materiali</label>
                 <span id="sim-val" style="font-weight:bold; color:var(--warn)">0%</span>
              </div>
              <input type="range" id="sim-slider" min="-20" max="50" value="0" style="width:100%; accent-color:var(--warn)">
              <div class="small muted">Sposta per vedere come cambia il margine senza modificare i dati reali.</div>
           </div>

           <div class="row" style="margin-bottom:12px;">
              <div class="col" style="grid-column: span 4">
                 <div class="stat-card">
                    <span class="stat-lbl">Incidenza Manodopera</span>
                    <span class="stat-val" id="stat-inc-man">0%</span>
                 </div>
              </div>
              <div class="col" style="grid-column: span 4">
                 <div class="stat-card">
                    <span class="stat-lbl">Costo al kg (Finito)</span>
                    <span class="stat-val" id="stat-eur-kg">0,00 ‚Ç¨</span>
                 </div>
              </div>
              <div class="col" style="grid-column: span 4">
                 <div class="stat-card">
                    <span class="stat-lbl">Moltiplicatore</span>
                    <span class="stat-val" id="stat-mult">1.0x</span>
                 </div>
              </div>
           </div>
           
           <div style="height:150px; width:100%;">
              <canvas id="categoryBarChart"></canvas>
           </div>
        </div>
     </div>
  </div>

  <!-- TOOLBAR AZIONI + SCENARI -->
  <div class="card pad h" style="margin-top:16px; justify-content:space-between; flex-wrap:wrap">
     <div class="h">
       <button id="btn-reset" class="btn">Nuovo / Pulisci</button>
       <button id="btn-seed" class="btn">Ricarica Default</button>
       <button id="btn-save-as" class="btn">Salva HTML</button> <!-- REINTRODOTTO -->
       <div style="width:1px; height:24px; background:var(--grid)"></div>
       
       <!-- Gestione Scenari -->
       <div class="pill h" style="background:#151d28; padding:4px 8px; border-radius:8px; border:1px solid var(--grid)">
          <span class="small muted">Scenari:</span>
          <button id="save-A" class="btn small" title="Salva Scenario A">üíæ A</button>
          <button id="load-A" class="btn small" title="Carica Scenario A">üìÇ A</button>
          <div style="width:1px; height:16px; background:var(--grid)"></div>
          <button id="save-B" class="btn small" title="Salva Scenario B">üíæ B</button>
          <button id="load-B" class="btn small" title="Carica Scenario B">üìÇ B</button>
       </div>
     </div>
     
     <div class="h">
       <button id="btn-abachi" class="btn-acc">Importa Abachi Revit</button>
       <div style="width:1px; height:24px; background:var(--grid)"></div>
       <button id="btn-export-xlsx" class="btn-ok">Esporta Excel</button>
       <button id="btn-import-xlsx" class="btn">Importa Excel</button>
     </div>
  </div>

  <!-- SEZIONE ABACHI (Nascosta) -->
  <div class="card pad" id="abachi-card" style="margin-top:16px; display:none">
     <div class="h" style="justify-content:space-between">
        <h2>Abachi Revit Importati</h2>
        <button onclick="document.getElementById('abachi-card').style.display='none'" class="btn small">Chiudi</button>
     </div>
     <div id="abachi-tabs"></div>
     <div id="abachi-host"></div>
  </div>

  <div class="muted small right" style="margin-top:16px">
     V 4.1 Ultimate Fix - Stampa - Scenari - Catalogo - Geometria
  </div>
  <div class="footer-print">
     Documento generato automaticamente il <span id="print-date"></span> - Analisi Costi V4.1
  </div>

</div>

<!-- TEMPLATE RIGA -->
<template id="row-template">
  <tr>
    <td class="muted right num" style="font-size:11px"></td>
    <td contenteditable data-key="categoria" spellcheck="false"></td>
    <td contenteditable data-key="voce" spellcheck="false"></td>
    <td class="right num" contenteditable data-key="qty"></td>
    <td contenteditable data-key="um" class="muted" style="text-align:center"></td>
    <td class="right num" contenteditable data-key="costo"></td>
    <td class="right num" contenteditable data-key="koc"></td>
    <td class="right num" data-key="tot" style="font-weight:bold; color:var(--ink)"></td>
    <td contenteditable data-key="note" class="muted small"></td>
  </tr>
</template>

<!-- INPUT FILE NASCOSTI -->
<input type="file" id="file-import-xlsx" accept=".xlsx" style="display:none" />
<input type="file" id="file-abachi" accept=".xlsx" style="display:none" />

<script>
// --- MODAL SYSTEM ---
const modal = document.getElementById('custom-modal');
const mTitle = document.getElementById('modal-title');
const mContent = document.getElementById('modal-content');
const mYes = document.getElementById('modal-confirm');
const mNo = document.getElementById('modal-cancel');

let currentCallback = null;

function resetModal() {
  mContent.innerHTML = '<p id="modal-msg"></p>';
  mYes.style.display = 'none';
  mYes.textContent = 'Conferma';
  mNo.textContent = 'Chiudi';
  mNo.onclick = closeModal;
}

function showConfirm(title, msg, callback) {
   resetModal();
   mTitle.textContent = title;
   document.getElementById('modal-msg').textContent = msg;
   currentCallback = callback;
   modal.classList.add('active');
   mYes.style.display = 'block';
   mNo.textContent = 'Annulla';
}

function showAlert(title, msg) {
   resetModal();
   mTitle.textContent = title;
   document.getElementById('modal-msg').textContent = msg;
   currentCallback = null;
   modal.classList.add('active');
}

// Custom Modal Content (HTML injection)
function showCustomModal(title, html, callback) {
   resetModal();
   mTitle.textContent = title;
   mContent.innerHTML = html;
   if(callback) {
     currentCallback = callback;
     mYes.style.display = 'block';
     mYes.textContent = 'Applica';
     mNo.textContent = 'Annulla';
   }
   modal.classList.add('active');
}

function closeModal() {
   modal.classList.remove('active');
   currentCallback = null;
}

mYes.onclick = () => {
   if(currentCallback) {
      if(currentCallback() !== false) closeModal();
   } else {
      closeModal();
   }
};

// --- UTILS & FORMATTERS ---
const fmt = new Intl.NumberFormat('it-IT', {minimumFractionDigits:2, maximumFractionDigits:2});
const money = v => `${fmt.format(v||0)} ‚Ç¨`;

function parseSmart(val){
  if(val == null) return 0;
  let s = String(val).trim().replace(/‚Ç¨/g,'').replace(/\s/g,'');
  if(!s) return 0;
  if(s.includes(',') && s.indexOf('.') < s.indexOf(',')){ 
     s = s.replace(/\./g,'').replace(',','.'); 
  } else if(s.includes(',')) {
     s = s.replace(',','.');
  }
  const v = parseFloat(s);
  return isFinite(v) ? v : 0;
}

function setNum(el, v, isMoney=false) { 
   el.textContent = isMoney ? money(v) : fmt.format(v); 
}

const tbody = document.getElementById('tbody');
const tpl = document.getElementById('row-template');

// --- CHART.JS ---
let pieChart = null;
let barChart = null;

function initCharts() {
  const ctxPie = document.getElementById('costPieChart').getContext('2d');
  const ctxBar = document.getElementById('categoryBarChart').getContext('2d');
  Chart.defaults.color = '#b7c2cf';
  Chart.defaults.borderColor = '#263042';

  pieChart = new Chart(ctxPie, {
    type: 'doughnut',
    data: {
      labels: ['Materiali', 'Manodopera', 'Altri'],
      datasets: [{ data: [0, 0, 0], backgroundColor: ['#4cc9f0', '#f59e0b', '#2dd4bf'], borderWidth: 0 }]
    },
    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
  });

  barChart = new Chart(ctxBar, {
    type: 'bar',
    data: { labels: [], datasets: [{ label: 'Top Costi', data: [], backgroundColor: '#4cc9f0', borderRadius: 4 }] },
    options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', plugins: { legend: { display:false } }, scales: { x: { beginAtZero: true } } }
  });
}

function updateCharts(tMat, tMan, tAlt, rowsData) {
  if(!pieChart || !barChart) return;
  pieChart.data.datasets[0].data = [tMat, tMan, tAlt];
  pieChart.update();
  const sorted = rowsData.sort((a,b) => b.tot - a.tot).slice(0, 5);
  barChart.data.labels = sorted.map(x => x.voce.substring(0, 15) + (x.voce.length>15?'...':''));
  barChart.data.datasets[0].data = sorted.map(x => x.tot);
  barChart.update();
}

// --- CORE LOGIC ---
let sensitivityFactor = 0; // %

function newRow(data={}) {
  const tr = tpl.content.firstElementChild.cloneNode(true);
  const keys = ['categoria','voce','qty','um','costo','koc','tot','note'];
  keys.forEach(k => {
    const cell = tr.querySelector(`[data-key="${k}"]`);
    if(!cell) return;
    if(k==='tot') setNum(cell, data[k]||0, true);
    else cell.textContent = data[k] || '';
  });
  tbody.appendChild(tr);
  refreshIndex();
  return tr;
}

function refreshIndex(){
  [...tbody.rows].forEach((tr,i) => { tr.cells[0].textContent = i+1; });
}

function calcTotals() {
  let totMat=0, totMan=0, totAlt=0;
  const rowsData = [];
  
  [...tbody.rows].forEach(tr => {
     if(tr.style.display === 'none') return;
     const cat = tr.querySelector('[data-key="categoria"]').textContent.trim();
     const voce = tr.querySelector('[data-key="voce"]').textContent.trim();
     const catL = cat.toLowerCase();
     const q = parseSmart(tr.querySelector('[data-key="qty"]').textContent);
     const c = parseSmart(tr.querySelector('[data-key="costo"]').textContent);
     const k = parseSmart(tr.querySelector('[data-key="koc"]').textContent);
     
     let base = q * c;
     let tot = (k > 0 && k < 100) ? base / (1 - (k/100)) : base;
     
     // APPLY SENSITIVITY only to Materials
     if (sensitivityFactor !== 0 && catL.startsWith('mat')) {
        tot = tot * (1 + sensitivityFactor/100);
     }

     setNum(tr.querySelector('[data-key="tot"]'), tot, true);
     
     if(catL.startsWith('mat')) totMat += tot;
     else if(catL.startsWith('manod')) totMan += tot;
     else totAlt += tot;
     
     rowsData.push({ voce: voce || cat, tot: tot });
  });
  
  document.getElementById('tot-mat').textContent = money(totMat);
  document.getElementById('tot-man').textContent = money(totMan);
  document.getElementById('tot-alt').textContent = money(totAlt);
  
  const diretto = totMat + totMan + totAlt;
  document.getElementById('tot-diretto').textContent = money(diretto);
  
  if(window.Chart) updateCharts(totMat, totMan, totAlt, rowsData);
  return diretto;
}

function applySummary() {
  const diretto = calcTotals();
  
  const gg = parseSmart(document.getElementById('pct-gg').value);
  const imp = parseSmart(document.getElementById('pct-imp').value);
  let provv = parseSmart(document.getElementById('pct-provv').value);
  const ut = parseSmart(document.getElementById('pct-ut').value);
  let marg = parseSmart(document.getElementById('pct-margine').value);
  const iva = parseSmart(document.getElementById('pct-iva').value);
  const sconto = parseSmart(document.getElementById('pct-sconto').value);
  
  const pz = parseSmart(document.getElementById('pezzi').value) || 1;
  const vol = parseSmart(document.getElementById('vol').value) || 0;
  const mlpz = parseSmart(document.getElementById('ml-per-pezzo').value) || 0;
  const mqpz = parseSmart(document.getElementById('mq-per-pezzo').value) || 0;
  const supMont = parseSmart(document.getElementById('sup-mont').value) || 0;
  
  const valGG = diretto * (gg/100);
  const valIMP = (diretto + valGG) * (imp/100);
  const sub = diretto + valGG + valIMP;
  
  if(provv >= 100) provv = 99.9;
  const baseDopoProvv = provv > 0 ? sub / (1 - (provv/100)) : sub;
  const valProvv = baseDopoProvv - sub;
  
  const valUT = baseDopoProvv * (ut/100);
  const baseDopoUtile = baseDopoProvv + valUT;
  
  if(marg >= 100) marg = 99.9;
  const netto = marg > 0 ? baseDopoUtile / (1 - (marg/100)) : baseDopoUtile;
  const valMarg = netto - baseDopoUtile;
  
  const valIVA = netto * (iva/100);
  const totale = netto + valIVA;
  const valSconto = totale * (sconto/100);
  const totScontato = totale - valSconto;

  const margComm = totScontato > 0 ? ((totScontato - sub) / totScontato) * 100 : 0;

  document.getElementById('r-dir').textContent = money(diretto);
  document.getElementById('r-gg').textContent = money(valGG);
  document.getElementById('r-imp').textContent = money(valIMP);
  document.getElementById('r-sub').textContent = money(sub);
  document.getElementById('r-provv').textContent = money(valProvv);
  document.getElementById('r-ut').textContent = money(valUT);
  document.getElementById('r-margine').textContent = money(valMarg);
  document.getElementById('r-netto').textContent = money(netto);
  document.getElementById('r-iva').textContent = money(valIVA);
  document.getElementById('r-totale').textContent = money(totale);
  document.getElementById('r-sconto').textContent = money(valSconto);
  document.getElementById('r-totale-sconto').textContent = money(totScontato);
  document.getElementById('r-margine-commessa').textContent = fmt.format(margComm) + ' %';
  
  const totFin = totScontato;
  document.getElementById('r-per-pezzo').textContent = money(totFin / pz);
  const mlTot = mlpz > 0 ? mlpz * pz : (parseSmart(document.getElementById('len').value) || 0) * pz;
  document.getElementById('r-per-ml').textContent = mlTot > 0 ? money(totFin / mlTot) : '0,00 ‚Ç¨';
  const mqTot = mqpz > 0 ? mqpz * pz : 0;
  document.getElementById('r-per-mq').textContent = mqTot > 0 ? money(totFin / mqTot) : '0,00 ‚Ç¨';
  const mcTot = vol > 0 ? vol * pz : 0;
  document.getElementById('r-per-mc').textContent = mcTot > 0 ? money(totFin / mcTot) : '0,00 ‚Ç¨';
  document.getElementById('r-per-mc-struttura').textContent = mcTot > 0 ? money(totFin / mcTot) : '0,00 ‚Ç¨';
  
  const pesoTot = vol * 2.5 * 1000; 
  document.getElementById('peso').value = fmt.format(pesoTot/1000);
  
  // Stats
  const manPerc = diretto > 0 ? (parseSmart(document.getElementById('tot-man').textContent)/diretto)*100 : 0;
  document.getElementById('stat-inc-man').textContent = fmt.format(manPerc) + '%';
  const costKg = pesoTot > 0 ? (totFin / pesoTot) : 0;
  document.getElementById('stat-eur-kg').textContent = fmt.format(costKg) + ' ‚Ç¨';
  const mult = diretto > 0 ? (totFin / diretto) : 0;
  document.getElementById('stat-mult').textContent = fmt.format(mult) + 'x';
  
  saveToLocal();
}

// --- CATALOG & GEOMETRY MODALS ---

const catalogItems = [
  {c:'Materiali', v:'Calcestruzzo C45/55', u:'m¬≥', p:'108,00'},
  {c:'Materiali', v:'Acciaio B450C Barre', u:'kg', p:'0,65'},
  {c:'Materiali', v:'Trefolo 0.6"', u:'kg', p:'0,95'},
  {c:'Materiali', v:'Inserti Vari', u:'pz', p:'15,00'},
  {c:'Manodopera', v:'Squadra Carpenteria', u:'h', p:'28,00'},
  {c:'Manodopera', v:'Finitura', u:'h', p:'32,00'},
  {c:'Trasporti', v:'Viaggio Bilico', u:'viaggio', p:'450,00'},
  {c:'Noli', v:'Gru 100t', u:'h', p:'120,00'}
];

document.getElementById('btn-catalog').onclick = () => {
  const html = `
    <div class="catalog-list">
      ${catalogItems.map((i, idx) => `
        <div class="catalog-item" onclick="pickItem(${idx})">
           <span style="font-weight:bold">${i.v}</span>
           <span>${i.p} ‚Ç¨/${i.u}</span>
        </div>
      `).join('')}
    </div>
  `;
  // Global helper
  window.pickItem = (idx) => {
     const it = catalogItems[idx];
     newRow({categoria:it.c, voce:it.v, qty:'1,00', um:it.u, costo:it.p, koc:'0,00'});
     applySummary();
     closeModal();
  };
  showCustomModal("Catalogo Prezzi", html, null); // No confirm needed, click selects
};

document.getElementById('btn-geom-calc').onclick = () => {
  const html = `
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
       <div class="col"><label>Tipo Sezione</label>
         <select id="gc-type" style="background:#0f1520; color:white; border:1px solid #444; padding:4px;">
           <option value="rect">Rettangolare</option>
           <option value="ibeam">Trave a I</option>
         </select>
       </div>
       <div class="col"><label>Lunghezza (m)</label><input id="gc-l" type="number" step="0.01"></div>
       <div class="col"><label>Base Inf (m)</label><input id="gc-b1" type="number" step="0.01"></div>
       <div class="col"><label>Altezza (m)</label><input id="gc-h" type="number" step="0.01"></div>
       <div class="col hidden" id="box-b2"><label>Base Sup (m)</label><input id="gc-b2" type="number" step="0.01"></div>
       <div class="col hidden" id="box-tw"><label>Spess. Anima (m)</label><input id="gc-tw" type="number" step="0.01"></div>
    </div>
    <div style="margin-top:12px; font-size:12px; color:#aaa">Compila i campi per calcolare il volume.</div>
  `;
  
  showCustomModal("Calcolatrice Geometrica", html, () => {
     const t = document.getElementById('gc-type').value;
     const L = parseFloat(document.getElementById('gc-l').value)||0;
     const H = parseFloat(document.getElementById('gc-h').value)||0;
     const B1 = parseFloat(document.getElementById('gc-b1').value)||0;
     let area = 0;
     
     if(t === 'rect') {
        area = B1 * H;
     } else {
        const B2 = parseFloat(document.getElementById('gc-b2').value)||B1;
        const tw = parseFloat(document.getElementById('gc-tw').value)||0.2;
        // Semplificazione I-beam: 2 ali + anima
        // Ala inf: B1 * 0.15 (stima), Ala sup: B2 * 0.15, Anima: (H - 0.3)*tw
        // Per precisione, servirebbero input altezze ali. Usiamo formula semplice:
        // Area = (B1*H) - ((B1-tw)*(H-0.2)); // Molto approssimativo.
        // Meglio: chiediamo area secca o lasciamo rettangolare.
        // Facciamo calcolo base pesata:
        area = (B1*0.2) + (B2*0.2) + (tw * (H-0.4)); 
     }
     const vol = area * L;
     document.getElementById('vol').value = vol.toFixed(3);
     document.getElementById('len').value = L.toFixed(2);
     document.getElementById('wid').value = B1.toFixed(2);
     document.getElementById('hei').value = H.toFixed(2);
     applySummary();
  });
  
  // Logic to show/hide fields
  setTimeout(() => {
     const sel = document.getElementById('gc-type');
     const b2 = document.getElementById('box-b2');
     const tw = document.getElementById('box-tw');
     if(sel) {
        sel.onchange = () => {
           if(sel.value === 'ibeam') { b2.style.display='flex'; tw.style.display='flex'; }
           else { b2.style.display='none'; tw.style.display='none'; }
        };
     }
  }, 100);
};

// --- EVENTS ---
tbody.addEventListener('input', e => {
   const td = e.target;
   const key = td.getAttribute('data-key');
   if(key === 'categoria' || key === 'voce') {
      const txt = (td.textContent||'').toLowerCase();
      if(txt.includes('montaggio') || txt.includes('trasport') || txt.includes('complementar')) {
         const tr = td.closest('tr');
         const kCell = tr.querySelector('[data-key="koc"]');
         if(parseSmart(kCell.textContent) === 0) kCell.textContent = '10,00';
      }
   }
   applySummary();
});

tbody.addEventListener('click', e => {
   const tr = e.target.closest('tr');
   if(!tr) return;
   [...tbody.rows].forEach(r => r.classList.remove('sel'));
   tr.classList.add('sel');
});

document.getElementById('add-row').onclick = () => { newRow({categoria:'Materiali', voce:'Nuova voce', qty:'1,00', um:'pz', costo:'0,00'}); applySummary(); };
document.getElementById('del-row').onclick = () => {
   const sel = tbody.querySelector('.sel');
   if(sel) { sel.remove(); applySummary(); refreshIndex(); } 
   else { showAlert("Attenzione", "Seleziona una riga per eliminarla (click sulla riga)."); }
};
document.getElementById('dup-row').onclick = () => {
   const sel = tbody.querySelector('.sel');
   if(sel) {
      const data = {};
      ['categoria','voce','qty','um','costo','koc','note'].forEach(k => { data[k] = sel.querySelector(`[data-key="${k}"]`).textContent; });
      newRow(data); applySummary();
   } else { showAlert("Attenzione", "Seleziona una riga per duplicarla."); }
};

document.getElementById('btn-calc').onclick = applySummary;
document.getElementById('btn-calc-fixed').onclick = applySummary;
document.getElementById('filter-cat').addEventListener('change', (e) => {
   const filter = e.target.value.toLowerCase();
   [...tbody.rows].forEach(tr => {
      const cat = tr.querySelector('[data-key="categoria"]').textContent.toLowerCase();
      tr.style.display = (!filter || cat.includes(filter)) ? '' : 'none';
   });
   applySummary();
});
document.querySelectorAll('input').forEach(el => {
   el.addEventListener('change', applySummary);
   el.addEventListener('input', applySummary);
});

// SENSITIVITY SLIDER
document.getElementById('sim-slider').addEventListener('input', (e) => {
   sensitivityFactor = parseFloat(e.target.value);
   document.getElementById('sim-val').textContent = (sensitivityFactor>0?'+':'') + sensitivityFactor + '%';
   document.getElementById('sim-display').textContent = (sensitivityFactor>0?'+':'') + sensitivityFactor + '%';
   applySummary();
});

// --- PERSISTENZA & SCENARI ---
function getSnapshot() {
   const rows = [...tbody.rows].map(tr => {
      const d = {};
      ['categoria','voce','qty','um','costo','koc','note'].forEach(k => { d[k] = tr.querySelector(`[data-key="${k}"]`).textContent; });
      return d;
   });
   const inputs = {};
   document.querySelectorAll('input, select').forEach(el => { if(el.id) inputs[el.id] = el.value; });
   return { rows, inputs };
}

function restoreSnapshot(data) {
   if(!data) return;
   if(data.inputs) {
      for(const id in data.inputs) {
         const el = document.getElementById(id);
         if(el) el.value = data.inputs[id];
      }
   }
   tbody.innerHTML = '';
   if(data.rows && data.rows.length) { data.rows.forEach(r => newRow(r)); } 
   else { seedDefaults(); }
   
   // Reset slider on load to avoid confusion
   document.getElementById('sim-slider').value = 0;
   sensitivityFactor = 0;
   
   applySummary();
}

document.getElementById('save-A').onclick = () => { localStorage.setItem('acp_scenario_A', JSON.stringify(getSnapshot())); showAlert("Scenario A", "Salvato!"); };
document.getElementById('load-A').onclick = () => { const d = localStorage.getItem('acp_scenario_A'); if(d) restoreSnapshot(JSON.parse(d)); else showAlert("Scenario A", "Nessun dato salvato."); };
document.getElementById('save-B').onclick = () => { localStorage.setItem('acp_scenario_B', JSON.stringify(getSnapshot())); showAlert("Scenario B", "Salvato!"); };
document.getElementById('load-B').onclick = () => { const d = localStorage.getItem('acp_scenario_B'); if(d) restoreSnapshot(JSON.parse(d)); else showAlert("Scenario B", "Nessun dato salvato."); };

function saveToLocal() { localStorage.setItem('acp_sticky_v3', JSON.stringify(getSnapshot())); }
document.getElementById('btn-save').onclick = () => { saveToLocal(); showAlert("Salvataggio", "Dati salvati nel browser."); };

// --- PRINT ---
document.getElementById('btn-print').onclick = () => {
   const now = new Date();
   document.getElementById('print-date').textContent = now.toLocaleDateString() + ' ' + now.toLocaleTimeString();
   window.print();
};

document.getElementById('btn-reset').onclick = () => {
   showConfirm("Nuovo / Pulisci", "Cancellare tutto?", () => { tbody.innerHTML = ''; newRow({categoria:'Materiali', voce:'‚Äî', qty:'0', costo:'0'}); applySummary(); });
};
document.getElementById('btn-seed').onclick = () => {
   showConfirm("Ricarica Default", "Ricaricare i dati base?", () => { seedDefaults(); applySummary(); });
};

function seedDefaults() {
   tbody.innerHTML = '';
   const defs = [
      {categoria:'Materiali', voce:'Calcestruzzo (classe C45/55)', qty:'0,00', um:'m¬≥', costo:'108,00', koc:'0,00', note:'Q.t√† manuale'},
      {categoria:'Materiali', voce:'Additivo fluidificante', qty:'0,00', um:'kg', costo:'0,00', koc:'0,00', note:''},
      {categoria:'Materiali', voce:'Disarmante casseri', qty:'0,00', um:'kg', costo:'0,00', koc:'0,00', note:''},
      {categoria:'Materiali', voce:'Coibente / Isolante', qty:'0,00', um:'m¬≥', costo:'68,00', koc:'0,00', note:''},
      {categoria:'Materiali', voce:'Alleggerimento (es. EPS)', qty:'0,00', um:'m¬≥', costo:'34,00', koc:'0,00', note:''},
      {categoria:'Materiali', voce:'Trefolo precompresso 0,6" (√ò 15,7)', qty:'0,00', um:'kg', costo:'0,95', koc:'0,00', note:''},
      {categoria:'Materiali', voce:'Tralicci ', qty:'0,00', um:'kg', costo:'1,40', koc:'0,00', note:''},
      {categoria:'Materiali', voce:'Acciaio diritto passivo ‚Äì barre/staffe B450C', qty:'0,00', um:'kg', costo:'0,65', koc:'0,00', note:''},
      {categoria:'Materiali', voce:'Acciaio lavorato passivo ‚Äì barre/staffe B450C', qty:'0,00', um:'kg', costo:'1.20', koc:'0,00', note:''},
      {categoria:'Materiali', voce:'Rete elettrosaldata dritta', qty:'0,00', um:'kg', costo:'0,75', koc:'0,00', note:''},
      {categoria:'Materiali', voce:'Rete elettrosaldata lavorata', qty:'0,00', um:'kg', costo:'1,30', koc:'0,00', note:''},
      {categoria:'Materiali', voce:'Guaina / distanziatori trefoli', qty:'0,00', um:'m / pz', costo:'0,00', koc:'0,00', note:''},
      {categoria:'Materiali', voce:'Inserti (bussole, golfari, piastre, asole)', qty:'0,00', um:'pz/lotto', costo:'0,00', koc:'0,00', note:''},
      {categoria:'Materiali', voce:'Sigillanti / resine / ancoranti chimici', qty:'0,00', um:'lotto', costo:'0,00', koc:'0,00', note:''},
      {categoria:'Materiali', voce:'Casseri ausiliari / sponde (consumabili)', qty:'0,00', um:'lotto', costo:'0,00', koc:'0,00', note:''},
      {categoria:'Manodopera', voce:'Tracciatura / preparazione cassero', qty:'0,00', um:'h', costo:'0,00', koc:'0,00', note:''},
      {categoria:'Manodopera', voce:'Posa armature passive', qty:'0,00', um:'h', costo:'0,00', koc:'0,00', note:''},
      {categoria:'Manodopera', voce:'Posa trefoli e tensionamento', qty:'0,00', um:'h', costo:'0,00', koc:'0,00', note:''},
      {categoria:'Manodopera', voce:'Getto calcestruzzo', qty:'0,00', um:'h', costo:'0,00', koc:'0,00', note:''},
      {categoria:'Manodopera', voce:'Cura/gestione ciclo (maturazione)', qty:'0,00', um:'h', costo:'0,00', koc:'0,00', note:''},
      {categoria:'Manodopera', voce:'Taglio/ritensionamento trefoli', qty:'0,00', um:'h', costo:'0,00', koc:'0,00', note:''},
      {categoria:'Manodopera', voce:'Disarmo e finitura', qty:'0,00', um:'h', costo:'0,00', koc:'0,00', note:''},
      {categoria:'Manodopera', voce:'Controlli qualit√† / dimensione', qty:'0,00', um:'h', costo:'0,00', koc:'0,00', note:''},
      {categoria:'Manodopera', voce:'Movimentazioni interne / carico', qty:'0,00', um:'h', costo:'0,00', koc:'0,00', note:''},
      {categoria:'Energia/Cura', voce:'Energia elettrica / vapore ciclo', qty:'0,00', um:'kWh/lotto', costo:'0,00', koc:'0,00', note:''},
      {categoria:'Impianti/Noli', voce:'Uso impianti / linee / piste', qty:'0,00', um:'h/lotto', costo:'0,00', koc:'0,00', note:''},
      {categoria:'Impianti/Noli', voce:'Nolo betonpompa / attrezzature getto', qty:'0,00', um:'h/lotto', costo:'0,00', koc:'0,00', note:''},
      {categoria:'Impianti/Noli', voce:'Nolo gru interna / carroponti', qty:'0,00', um:'h', costo:'0,00', koc:'0,00', note:''},
      {categoria:'Impianti/Noli', voce:'Vibratori / attrezzature finitura', qty:'0,00', um:'h/lotto', costo:'0,00', koc:'0,00', note:''},
      {categoria:'Attrezzature/Stampi', voce:'Ammortamento stampi specifici', qty:'0,00', um:'quota/pezzo', costo:'0,00', koc:'0,00', note:''},
      {categoria:'Attrezzature/Stampi', voce:'Manutenzione stampi / attrezzature', qty:'0,00', um:'quota/pezzo', costo:'0,00', koc:'0,00', note:''},
      {categoria:'Qualit√†/Collaudi', voce:'Prove cubetti / certificazioni cls', qty:'0,00', um:'lotto', costo:'0,00', koc:'0,00', note:''},
      {categoria:'Qualit√†/Collaudi', voce:'Controlli dimensionali e visivi', qty:'0,00', um:'lotto', costo:'0,00', koc:'0,00', note:''},
      {categoria:'Sicurezza/Ambiente', voce:'DPI / sicurezza ciclo produttivo', qty:'0,00', um:'quota/pezzo', costo:'0,00', koc:'0,00', note:''},
      {categoria:'Sicurezza/Ambiente', voce:'Smaltimenti / fanghi / rifiuti', qty:'0,00', um:'lotto', costo:'0,00', koc:'0,00', note:''},
      {categoria:'Logistica interna', voce:'Movimentazioni interne aggiuntive', qty:'0,00', um:'h', costo:'0,00', koc:'0,00', note:''},
      {categoria:'Imballo/Stoccaggio', voce:'Imballi / distanziatori / reggiatura', qty:'0,00', um:'lotto', costo:'0,00', koc:'0,00', note:''},
      {categoria:'Imballo/Stoccaggio', voce:'Stoccaggio in piazzale', qty:'0,00', um:'giorno/pezzo', costo:'0,00', koc:'0,00', note:''},
      {categoria:'Trasporti', voce:'Bilico ‚Äì costo a km', qty:'0,00', um:'km', costo:'0,00', koc:'0,00', note:''},
      {categoria:'Trasporti', voce:'Bilico ‚Äì costo a viaggio', qty:'0,00', um:'viaggio', costo:'0,00', koc:'0,00', note:''},
      {categoria:'Trasporti', voce:'Scorta tecnica / permessi eccezionali', qty:'0,00', um:'viaggio', costo:'0,00', koc:'0,00', note:''},
      {categoria:'Trasporti', voce:'Pedaggi / traghetti', qty:'0,00', um:'viaggio', costo:'0,00', koc:'0,00', note:''},
      {categoria:'Trasporti', voce:'Carico camion / fissaggi', qty:'0,00', um:'lotto', costo:'0,00', koc:'0,00', note:''},
      {categoria:'Montaggio', voce:'Caposquadra / preposto', qty:'0,00', um:'h', costo:'0,00', koc:'0,00', note:''},
      {categoria:'Montaggio', voce:'Squadra montaggio', qty:'0,00', um:'h', costo:'0,00', koc:'0,00', note:''},
      {categoria:'Montaggio', voce:'Nolo gru cantiere', qty:'0,00', um:'h', costo:'0,00', koc:'0,00', note:''},
      {categoria:'Montaggio', voce:'Piattaforme aeree (PLE)', qty:'0,00', um:'h', costo:'0,00', koc:'0,00', note:''},
      {categoria:'Montaggio', voce:'Attrezzature sollevamento (traverse)', qty:'0,00', um:'lotto', costo:'0,00', koc:'0,00', note:''},
      {categoria:'Montaggio', voce:'Bulloneria / resine / pernature', qty:'0,00', um:'lotto', costo:'0,00', koc:'0,00', note:''},
      {categoria:'Montaggio', voce:'Alloggi / trasferte personale', qty:'0,00', um:'giorno', costo:'0,00', koc:'0,00', note:''},
      {categoria:'Montaggio', voce:'Mezzi di supporto (furgoni, muletti)', qty:'0,00', um:'h/gg', costo:'0,00', koc:'0,00', note:''},
      {categoria:'Spese Tecniche', voce:'Progettazione esecutiva / disegni', qty:'0,00', um:'lotto', costo:'0,00', koc:'0,00', note:''},
      {categoria:'Spese Tecniche', voce:'Calcoli strutturali / pratiche', qty:'0,00', um:'lotto', costo:'0,00', koc:'0,00', note:''},
      {categoria:'Spese Tecniche', voce:'Direzione lavori / coordinamento', qty:'0,00', um:'lotto', costo:'0,00', koc:'0,00', note:''},
      {categoria:'Generali/Amministrative', voce:'Gestione commessa / amministrazione', qty:'0,00', um:'quota/pezzo', costo:'0,00', koc:'0,00', note:''},
      {categoria:'Manodopera Esterni', voce:'Getto Travi Rettangolari', qty:'0,00', um:'‚Ç¨/m¬≥', costo:'20,00', koc:'0,00', note:''},
      {categoria:'Manodopera Esterni', voce:'Getto Travi Sezione "I"', qty:'0,00', um:'‚Ç¨/m¬≥', costo:'20,00', koc:'0,00', note:''},
      {categoria:'Manodopera Esterni', voce:'Getto Arcarecci', qty:'0,00', um:'‚Ç¨/m¬≥', costo:'20,00', koc:'0,00', note:''},
      {categoria:'Manodopera Esterni', voce:'Getto TT', qty:'0,00', um:'‚Ç¨/m¬≥', costo:'20,00', koc:'0,00', note:''},
      {categoria:'Manodopera Esterni', voce:'Getto Pannelli Freddi', qty:'0,00', um:'‚Ç¨/m¬≥', costo:'20,00', koc:'0,00', note:''},
      {categoria:'Manodopera Esterni', voce:'Getto Pannelli Caldi', qty:'0,00', um:'‚Ç¨/m¬≥', costo:'20,00', koc:'0,00', note:''},
      {categoria:'Manodopera Esterni', voce:'Getto Pilastri', qty:'0,00', um:'‚Ç¨/m¬≥', costo:'20,00', koc:'0,00', note:''},
      {categoria:'Manodopera Esterni', voce:'Getto Gronda', qty:'0,00', um:'‚Ç¨/m¬≥', costo:'20,00', koc:'0,00', note:''},
      {categoria:'Manodopera Esterni', voce:'Getto Alare', qty:'0,00', um:'‚Ç¨/m¬≥', costo:'20,00', koc:'0,00', note:''},
      {categoria:'Manodopera Esterni', voce:'Getto Doppia Pendenza', qty:'0,00', um:'‚Ç¨/m¬≥', costo:'20,00', koc:'0,00', note:''},
      {categoria:'Manodopera Esterni', voce:'Stoccaggio', qty:'0,00', um:'‚Ç¨/m¬≥', costo:'11,00', koc:'0,00', note:''},
      {categoria:'Manodopera Esterni', voce:'Lavorazione Armature', qty:'0,00', um:'‚Ç¨/m¬≥', costo:'27,00', koc:'0,00', note:''},
      {categoria:'Manodopera Interni', voce:'Pulizia', qty:'0,00', um:'‚Ç¨/m¬≥', costo:'5,00', koc:'0,00', note:''},
      {categoria:'Manodopera Interni', voce:'Lavorazione Armature', qty:'0,00', um:'‚Ç¨/m¬≥', costo:'27,00', koc:'0,00', note:''},
      {categoria:'Manodopera Interni', voce:'Confezionamento Distribuzione Cls', qty:'0,00', um:'‚Ç¨/m¬≥', costo:'10,00', koc:'0,00', note:''},
      {categoria:'Manodopera Interni', voce:'Magazzino e Controllo', qty:'0,00', um:'‚Ç¨/m¬≥', costo:'1,50', koc:'0,00', note:''},
      {categoria:'Manodopera Altri', voce:'Imprevisti / Varie', qty:'0,00', um:'‚Ç¨/m¬≥', costo:'8,00', koc:'0,00', note:''}
   ];
   defs.forEach(d => newRow(d));
}

// Init Load
window.addEventListener('load', () => {
  initCharts();
  const saved = localStorage.getItem('acp_sticky_v3');
  if(saved) restoreSnapshot(JSON.parse(saved));
  else seedDefaults();
  applySummary();
});

// --- EXPORT / IMPORT ---
document.getElementById('btn-export-xlsx').onclick = () => {
   const wb = XLSX.utils.book_new();
   const snap = getSnapshot();
   const rowsParam = [['CAMPO', 'VALORE'],['Commessa', snap.inputs['job-name']],['Data', snap.inputs['job-date']],['Elemento', snap.inputs['el-desc']],['Volume', snap.inputs['vol']],['Prezzo Finale', document.getElementById('r-totale').textContent],[]];
   for(let k in snap.inputs) rowsParam.push([k, snap.inputs[k]]);
   XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(rowsParam), "Parametri");
   
   const headers = ['Categoria','Voce','Qta','UM','Costo Unit','K oc','Totale','Note'];
   const rowsData = [headers];
   [...tbody.rows].forEach(tr => {
      const r = [];
      ['categoria','voce','qty','um','costo','koc','tot','note'].forEach(k => {
         let val = tr.querySelector(`[data-key="${k}"]`).textContent;
         if(['qty','costo','koc','tot'].includes(k)) val = parseSmart(val);
         r.push(val);
      });
      rowsData.push(r);
   });
   XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(rowsData), "Analisi");
   XLSX.writeFile(wb, (snap.inputs['job-name']||'Analisi') + '.xlsx');
};

const impInp = document.getElementById('file-import-xlsx');
document.getElementById('btn-import-xlsx').onclick = () => impInp.click();
impInp.onchange = async (e) => {
   const f = e.target.files[0];
   if(!f) return;
   const data = await f.arrayBuffer();
   const wb = XLSX.read(data);
   const wsName = wb.SheetNames.find(n => n.toLowerCase().includes('analisi'));
   if(!wsName) { showAlert("Errore", 'Foglio "Analisi" non trovato.'); return; }
   const json = XLSX.utils.sheet_to_json(wb.Sheets[wsName]);
   showConfirm("Importazione", `Trovate ${json.length} righe. Sostituire?`, () => {
        tbody.innerHTML = '';
        json.forEach(row => newRow({categoria: row['Categoria'], voce: row['Voce'], qty: row['Qta'], um: row['UM'], costo: row['Costo Unit'], koc: row['K oc'], note: row['Note']}));
        applySummary(); impInp.value = '';
   });
};

const abaInp = document.getElementById('file-abachi');
document.getElementById('btn-abachi').onclick = () => abaInp.click();
abaInp.onchange = async (e) => {
   const f = e.target.files[0];
   if(!f) return;
   const data = await f.arrayBuffer();
   const wb = XLSX.read(data);
   const host = document.getElementById('abachi-host');
   const tabs = document.getElementById('abachi-tabs');
   host.innerHTML = ''; tabs.innerHTML = '';
   wb.SheetNames.forEach((name, idx) => {
      const btn = document.createElement('button');
      btn.textContent = name; btn.className = 'btn small ' + (idx===0?'active':'');
      btn.onclick = () => {
         tabs.querySelectorAll('button').forEach(b => b.classList.remove('active'));
         btn.classList.add('active');
         host.querySelectorAll('.sheet').forEach(s => s.classList.remove('active'));
         host.querySelector(`[data-idx="${idx}"]`).classList.add('active');
      };
      tabs.appendChild(btn);
      const div = document.createElement('div');
      div.className = 'sheet ' + (idx===0?'active':'');
      div.dataset.idx = idx;
      div.innerHTML = XLSX.utils.sheet_to_html(wb.Sheets[name]);
      host.appendChild(div);
   });
   document.getElementById('abachi-card').style.display='block';
   abaInp.value = '';
};

const btnSaveAs = document.getElementById('btn-save-as');
if(btnSaveAs) {
   btnSaveAs.onclick = () => {
      document.querySelectorAll('input, select').forEach(el => { if(el.type !== 'file') el.setAttribute('value', el.value); if(el.tagName === 'SELECT') { [...el.options].forEach(op => { if(op.selected) op.setAttribute('selected',''); else op.removeAttribute('selected'); }); } });
      const blob = new Blob([document.documentElement.outerHTML], {type: 'text/html'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = (document.getElementById('job-name').value || 'Analisi') + '.html';
      a.click();
   };
}
</script>
</body>
</html>
